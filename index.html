<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PV Schaltplan Generator</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- Symbol modules -->
  <script src="js/symbols/spd.js"></script>
  <script src="js/symbols/battery.js"></script>
  <script src="js/symbols/circuit-breaker.js"></script>
  <script src="js/symbols/sls.js"></script>
  <script src="js/symbols/meter.js"></script>
  <script src="js/symbols/pv-module.js"></script>
  <script src="js/symbols/inverter.js"></script>
  <script src="js/symbols/rcd.js"></script>
  <!-- Calculation module -->
  <script src="js/calculations.js"></script>
  <!-- Schaltplan generator -->
  <script src="js/schaltplan-generator.js"></script>
</head>
<body>
  <div class="sidebar">
    <div class="section-header" onclick="toggleSection('projekt')">
      <h2 class="section-title">Projekt</h2>
      <span class="chevron">‚ñº</span>
    </div>
    <div class="section-content" id="projekt-content">
      <label>Kundenanschrift
        <textarea id="projectAddress" placeholder="Name&#10;Stra√üe und Hausnummer&#10;PLZ und Ort&#10;Telefon" style="width:100%;min-height:80px;padding:8px;border:1px solid #ddd;border-radius:3px;font-family:inherit;font-size:12px;resize:vertical;box-sizing:border-box"></textarea>
      </label>
      <label>SLS-Schalter Gr√∂√üe
        <select id="slsSize">
          <option value="35">35A</option>
          <option value="50">50A</option>
        </select>
      </label>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="newProject" style="flex: 1">Neu</button>
        <button id="saveProject" style="flex: 1">Projekt speichern</button>
        <button id="openProject" style="flex: 1">Projekt √∂ffnen</button>
        <input id="loadFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <hr />
    <div class="section-header collapsed" onclick="toggleSection('pv-module')">
      <h2 class="section-title">PV-Module Konfiguration</h2>
      <span class="chevron collapsed">‚ñº</span>
    </div>
    <div class="section-content collapsed" id="pv-module-content">
      <div>
        <label>Hersteller + Typ
          <input id="moduleInfo" placeholder="z.B. SunPower Maxeon 3" />
        </label>
        <label>Modul Nennleistung (W)
          <input id="moduleWattage" type="number" min="1" value="420" />
        </label>
        <label>Modulbreite (cm)
          <input id="moduleWidthCm" type="number" min="1" value="178" />
        </label>
        <label>Modulh√∂he (cm)
          <input id="moduleHeightCm" type="number" min="1" value="115" />
        </label>
      </div>
    </div>

    <hr />
    <div class="section-header collapsed" onclick="toggleSection('solarflaechen')">
      <h2 class="section-title">Solarfl√§chen</h2>
      <span class="chevron collapsed">‚ñº</span>
    </div>
    <div class="section-content collapsed" id="solarflaechen-content">
      <div>
        <label>Name
          <input id="saName" placeholder="Dach S√ºd" />
        </label>
        <label>Anzahl Module
          <input id="saCount" type="number" min="1" value="10" />
        </label>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
          <button id="addSA">‚ûï Solarfl√§che hinzuf√ºgen</button>
          <button id="openMapModal">üó∫Ô∏è Dachfl√§che auf Karte einzeichnen</button>
          <button id="openCalcModal">üìê Modulanzahl berechnen</button>
        </div>
      </div>
      <div class="list">
        <table id="saTable"><thead><tr><th>ID</th><th>Name</th><th>Module</th><th>Leistung</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <hr />
    <div class="section-header collapsed" onclick="toggleSection('wechselrichter')">
      <h2 class="section-title">Wechselrichter</h2>
      <span class="chevron collapsed">‚ñº</span>
    </div>
    <div class="section-content collapsed" id="wechselrichter-content">
      <label>Name
        <input id="invName" placeholder="SMA Sunny Tripower" />
      </label>
      <label>Phasen
        <select id="invPhases"><option value="3-ph">3-ph</option><option value="1-ph">1-ph</option></select>
      </label>
      <label>AC-Nennleistung (W)
        <input id="invAcW" type="number" min="1" value="5000" />
      </label>
      <label>LS-Nennstrom (A)
        <input id="invLsAmps" type="number" min="6" max="125" value="25" />
        <div class="muted small" style="margin-top:2px;">Vorschlag wird automatisch berechnet (10m Leitungsl√§nge)</div>
      </label>
      <label>Leitungsquerschnitt (mm¬≤)
        <input id="invCableSize" type="number" min="1.5" max="50" step="0.5" value="4" />
        <div class="muted small" style="margin-top:2px;">Vorschlag wird automatisch berechnet (10m Leitungsl√§nge)</div>
      </label>
      <label style="display:flex;align-items:center;margin-top:12px;">
        <input id="invEmergencyPower" type="checkbox" style="width:auto;margin-right:8px;margin-top:0;" />
        Notstrom-Funktionalit√§t
      </label>
      <label>Solarfl√§chen zuordnen (STRG/SHIFT f√ºr mehrere)
        <select id="invAssign" multiple style="height:120px"></select>
      </label>
      <div style="margin-top:8px;display:flex;flex-direction:row;gap:6px">
        <button id="addInv" style="flex: 1">‚ûï Wechselrichter hinzuf√ºgen</button>
        <button id="cancelEditInv" style="display:none; flex: 1">‚ùå Abbrechen</button>
      </div>
      <div class="list">
        <div id="invContainer" class="cards-container"></div>
      </div>
    </div>
    <hr />
    <div class="section-header collapsed" onclick="toggleSection('batterie')">
      <h2 class="section-title">Batterie</h2>
      <span class="chevron collapsed">‚ñº</span>
    </div>
    <div class="section-content collapsed" id="batterie-content">
      <label>Name
        <input id="batName" placeholder="BatteryX" />
      </label>
      <label>Kapazit√§t (kWh)
        <input id="batKwh" type="number" min="0.1" step="0.1" value="10" />
      </label>
      <label>Max. Leistung (kW)
        <input id="batPowerKw" type="number" min="0" step="0.1" value="5" />
      </label>
      <label>Zugeordneter Wechselrichter
        <select id="batAssign"><option value="">-- keiner --</option></select>
      </label>
      <div style="margin-top:8px;display:flex;flex-direction:row;gap:6px">
        <button id="addBat" style="flex: 1">üîÑ Batterie aktualisieren</button>
        <button id="removeBat" class="danger" style="flex: 1">‚úï Batterie l√∂schen</button>
      </div>
    </div>

  </div>

  <div class="main">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="metaBox" class="small muted" style="margin-top:4px;">Keine Metadaten</div>
      </div>
      <div class="controls">
        <button id="schaltplanBtn" class="tab-btn active" onclick="switchTab('schaltplan')">Schaltplan</button>
        <button id="protokollBtn" class="tab-btn" onclick="switchTab('protokoll')">Pr√ºfprotokoll</button>
        <button id="gen">Schaltplan generieren</button>
        <button id="exportPdf">Export PDF</button>
        <button id="printProtocol" style="display:none">Drucken</button>
      </div>
    </header>

    <div id="tab-schaltplan" class="tab-content active">
      <div class="row">
        <div class="preview">
          <h3>Vorschau</h3>
          <div class="svg-container" id="svgWrap">Keine Vorschau. Bitte ‚ÄûSchaltplan generieren" klicken.</div>
        </div>
      </div>
    </div>

    <div id="tab-protokoll" class="tab-content" style="overflow-y:auto;padding:16px">
      <div class="protocol-header">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h1>Pr√ºfprotokoll ‚Äì Wechselrichter & PV‚ÄëAnlage</h1>
          <div style="text-align:right"><div><strong>Pr√ºfdatum:</strong> <input type="text" id="protocol-test-date" style="width:120px;border:none;border-bottom:2px solid var(--text-color);padding:2px 4px;font-size:12px;box-sizing:border-box"></div></div>
        </div>
      </div>

      <div class="protocol-section">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
          <div>
            <h3 style="font-size:13px;margin:0 0 8px 0;color:var(--primary-color)">Kunde</h3>
            <textarea id="protocol-customer" style="width:100%;min-height:120px;padding:8px;border:2px solid var(--border-color);border-radius:3px;font-family:inherit;font-size:12px;resize:vertical;box-sizing:border-box" placeholder="Name&#10;Firma (optional)&#10;Stra√üe und Hausnummer&#10;PLZ und Ort&#10;Telefon"></textarea>
          </div>
          <div>
            <h3 style="font-size:13px;margin:0 0 8px 0;color:var(--primary-color)">Pr√ºfer</h3>
            <textarea id="protocol-inspector" style="width:100%;min-height:120px;padding:8px;border:2px solid var(--border-color);border-radius:3px;font-family:inherit;font-size:12px;resize:vertical;box-sizing:border-box">Betriebsadresse&#10;Name&#10;Telefon</textarea>
          </div>
        </div>
      </div>

      <div class="protocol-section">
        <h2 class="protocol-section-title">Allgemeine Messwerte</h2>
        <table class="protocol-table">
          <thead>
            <tr>
              <th>Messgr√∂√üe</th>
              <th>Wert</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Erdwiderstand</td>
              <td><input id="protocol-earthing-value" type="text" value="8,9 Œ©" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;font-weight:bold;box-sizing:border-box"></td>
              <td><input id="protocol-earthing-status" type="text" value="‚úì i.O." style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
            </tr>
          </tbody>
        </table>

        <h3 class="protocol-section-title">Sichtpr√ºfung der DC-Verkabelung</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px" id="protocol-checks">
          <label style="display:flex;align-items:center;gap:8px;padding:6px;background:#fafafa;border-radius:3px;cursor:pointer">
            <input id="protocol-check-markings" type="checkbox" checked style="width:16px;height:16px;cursor:pointer">
            <span style="font-size:12px">Kennzeichnungen / Beschilderung</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:6px;background:#fafafa;border-radius:3px;cursor:pointer">
            <input id="protocol-check-breaker" type="checkbox" checked style="width:16px;height:16px;cursor:pointer">
            <span style="font-size:12px">DC-Freischalter vorhanden und beschriftet</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:6px;background:#fafafa;border-radius:3px;cursor:pointer">
            <input id="protocol-check-grounding" type="checkbox" checked style="width:16px;height:16px;cursor:pointer">
            <span style="font-size:12px">Potentialausgleich vorhanden und gepr√ºft</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:6px;background:#fafafa;border-radius:3px;cursor:pointer">
            <input id="protocol-check-surge" type="checkbox" checked style="width:16px;height:16px;cursor:pointer">
            <span style="font-size:12px">√úberspannungsschutz vorhanden (DC/AC)</span>
          </label>
        </div>
      </div>

      <div class="protocol-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h2 class="protocol-section-title" style="margin:0">Wechselrichter ‚Äì Messwerte</h2>
          <button class="protocol-btn" onclick="addInverter()">+ Wechselrichter hinzuf√ºgen</button>
        </div>
        <table class="protocol-table" id="inverters-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Z<sub>S</sub></th>
              <th>R<sub>Iso</sub></th>
              <th>R<sub>Low</sub></th>
              <th>Status</th>
              <th style="width:60px">Aktion</th>
            </tr>
          </thead>
          <tbody id="inverters-tbody">
          </tbody>
        </table>
      </div>

      <div class="protocol-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:15px">
          <h2 class="protocol-section-title" style="margin:0;flex-shrink:0">PV‚ÄëStrings ‚Äì Messwerte</h2>
          <div style="flex-grow:1;display:flex;align-items:center;gap:10px">
            <label style="font-size:11px;font-weight:600;color:var(--primary-color);white-space:nowrap">Modulbezeichnung:</label>
            <input type="text" id="module-designation" value="Trina Vertex S+ TSM-NEG9R.28 460W" style="flex-grow:1;padding:6px 8px;border:2px solid var(--border-color);border-radius:3px;font-size:11px;font-family:inherit;box-sizing:border-box">
          </div>
          <button class="protocol-btn" onclick="addString()">+ String hinzuf√ºgen</button>
        </div>

        <div style="display:flex;gap:15px;margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:4px;border:1px solid var(--border-color)">
          <div style="flex:1">
            <label style="font-size:11px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:4px">Wetterbedingungen</label>
            <select id="protocol-weather-condition" onchange="updateWeatherInRemarks()" style="width:100%;padding:6px 8px;border:2px solid var(--border-color);border-radius:3px;font-size:11px;font-family:inherit;box-sizing:border-box">
              <option value="sunny">Volle Sonne (klarer Himmel)</option>
              <option value="cloudy">Bew√∂lkt / diffuser Himmel</option>
              <option value="heavy-clouds">Starke Bew√∂lkung / Schatten</option>
              <option value="low-light">Sehr schwaches Licht / D√§mmerung</option>
            </select>
          </div>
          <div style="flex:0 0 150px">
            <label style="font-size:11px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:4px">I<sub>sc</sub> Referenz (A)</label>
            <input type="number" id="protocol-isc-reference" value="10.8" step="0.1" style="width:100%;padding:6px 8px;border:2px solid var(--border-color);border-radius:3px;font-size:11px;font-family:inherit;box-sizing:border-box">
          </div>
        </div>

        <table class="protocol-table" id="strings-table">
          <thead>
            <tr>
              <th>String</th>
              <th>Anzahl Module</th>
              <th>U<sub>oc</sub></th>
              <th>R<sub>Iso</sub></th>
              <th>I<sub>sc</sub></th>
              <th style="width:60px">Aktion</th>
            </tr>
          </thead>
          <tbody id="strings-tbody">
          </tbody>
        </table>
      </div>

      <div class="protocol-section" id="remarks-section">
        <div class="info-field" style="grid-column:1/-1">
          <label>Zus√§tzliche Hinweise</label>
          <textarea id="remarks-textarea" style="width:100%;min-height:50px;padding:8px;border:2px solid var(--border-color);border-radius:3px;font-family:inherit;font-size:12px;resize:vertical;box-sizing:border-box"></textarea>
        </div>
      </div>

      <div class="protocol-section">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <h3 style="font-size:12px;font-weight:600;color:var(--primary-color);margin:0 0 6px 0">Pr√ºfer</h3>
            <div style="display:grid;grid-template-columns:auto auto 1fr;gap:10px;align-items:end">
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Ort</label>
                <input type="text" style="width:80px;border:none;border-bottom:2px solid var(--text-color);padding:2px;font-size:11px;box-sizing:border-box">
              </div>
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Datum</label>
                <input type="text" style="width:90px;border:none;border-bottom:2px solid var(--text-color);padding:2px;font-size:11px;box-sizing:border-box">
              </div>
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Unterschrift</label>
                <div style="border-bottom:2px solid var(--text-color);height:22px"></div>
              </div>
            </div>
          </div>

          <div>
            <h3 style="font-size:12px;font-weight:600;color:var(--primary-color);margin:0 0 6px 0">Kunde</h3>
            <div style="display:grid;grid-template-columns:auto auto 1fr;gap:10px;align-items:end">
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Ort</label>
                <input type="text" style="width:80px;border:none;border-bottom:2px solid var(--text-color);padding:2px;font-size:11px;box-sizing:border-box">
              </div>
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Datum</label>
                <input type="text" style="width:90px;border:none;border-bottom:2px solid var(--text-color);padding:2px;font-size:11px;box-sizing:border-box">
              </div>
              <div>
                <label style="font-size:10px;font-weight:600;color:var(--primary-color);display:block;margin-bottom:2px">Unterschrift</label>
                <div style="border-bottom:2px solid var(--text-color);height:22px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Modal -->
  <div id="mapModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9000; overflow:auto; padding:20px; box-sizing:border-box;">
    <div style="background:#fff; border-radius:10px; max-width:900px; margin:0 auto; padding:16px; position:relative;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h2 style="margin:0; font-size:16px;">Dachfl√§che auf Karte einzeichnen</h2>
        <button id="mapModalClose">‚úï Schlie√üen</button>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <input id="mapSearch" type="text" placeholder="Adresse suchen..." style="flex:1;" />
        <button id="mapSearchBtn">Suchen</button>
        <button id="mapAutofillBtn" title="Geb√§ude an aktueller Kartenposition automatisch aus OpenStreetMap laden">üè† Geb√§ude erkennen</button>
      </div>
      <div id="mapSearchStatus" style="font-size:12px; color:#666; margin-bottom:6px; min-height:16px;"></div>
      <div id="leafletMap" style="height:420px; border-radius:6px; border:1px solid #ddd;"></div>
      <p style="font-size:12px; color:#666; margin:8px 0;">
        Zeichne ein Polygon (Werkzeug oben links) √ºber jede Dachfl√§che.
      </p>
      <div id="mapPolygonList" style="margin-top:12px;"></div>
    </div>
  </div>

  <div id="calcModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9000; overflow:auto; padding:20px; box-sizing:border-box;">
    <div style="background:#fff; border-radius:10px; max-width:480px; margin:40px auto; padding:20px; position:relative;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:16px;">üìê Modulanzahl berechnen</h2>
        <button id="calcModalClose">‚úï Schlie√üen</button>
      </div>

      <label style="font-size:13px;">Dachl√§nge (m)
        <input id="calcLength" type="number" min="0.1" step="0.1" value="8" />
      </label>
      <label style="font-size:13px;">Dachbreite (m)
        <input id="calcWidth" type="number" min="0.1" step="0.1" value="5" />
      </label>

      <div style="margin-top:12px; padding:10px; background:#f8fafc; border-radius:6px; border:1px solid #e2e8f0;">
        <div style="font-size:11px; color:#666; margin-bottom:6px;">Modulabmessungen (aus PV-Konfiguration)</div>
        <div style="display:flex; gap:8px;">
          <label style="flex:1; font-size:13px;">Breite (cm)
            <input id="calcModW" type="number" min="1" value="178" />
          </label>
          <label style="flex:1; font-size:13px;">H√∂he (cm)
            <input id="calcModH" type="number" min="1" value="115" />
          </label>
        </div>
      </div>

      <div id="calcResult" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- Leaflet map libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.js"></script>
  <!-- libs via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/svg2pdf.js@2.2.1/dist/svg2pdf.umd.min.js"></script>

  <script>
    // Toggle section visibility (Accordion)
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId + '-content');
      const header = event.target.closest('.section-header');
      const chevron = header.querySelector('.chevron');
      const isCollapsed = content.classList.contains('collapsed');

      // Alle Bereiche schlie√üen (Accordion)
      ['projekt', 'pv-module', 'solarflaechen', 'wechselrichter', 'batterie'].forEach(id => {
        const c = document.getElementById(id + '-content');
        const h = document.querySelector(`[onclick="toggleSection('${id}')"]`);
        const ch = h ? h.querySelector('.chevron') : null;
        if (c) c.classList.add('collapsed');
        if (h) h.classList.add('collapsed');
        if (ch) ch.classList.add('collapsed');
      });

      // Angeklickten Bereich √∂ffnen, falls er vorher geschlossen war
      if (isCollapsed) {
        content.classList.remove('collapsed');
        header.classList.remove('collapsed');
        chevron.classList.remove('collapsed');
      }
    }

    // Collapse all sections except the first one (Projekt)
    function collapseAllExceptFirst() {
      const sections = ['pv-module', 'solarflaechen', 'wechselrichter', 'batterie'];
      sections.forEach(sectionId => {
        const content = document.getElementById(sectionId + '-content');
        const header = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
        const chevron = header ? header.querySelector('.chevron') : null;

        if (content && header && chevron) {
          content.classList.add('collapsed');
          chevron.classList.add('collapsed');
          header.classList.add('collapsed');
        }
      });
    }

    // Print protocol function
    function printProtocol() {
      // Add weather condition to remarks before printing
      const weatherSelect = document.getElementById('protocol-weather-condition');
      const remarksTextarea = document.getElementById('remarks-textarea');
      let originalRemarks = '';

      if (weatherSelect && remarksTextarea) {
        const weatherOptions = {
          'sunny': 'Volle Sonne (klarer Himmel)',
          'cloudy': 'Bew√∂lkt / diffuser Himmel',
          'heavy-clouds': 'Starke Bew√∂lkung / Schatten',
          'low-light': 'Sehr schwaches Licht / D√§mmerung'
        };

        const selectedWeatherValue = weatherSelect.value;
        const weatherText = weatherOptions[selectedWeatherValue] || selectedWeatherValue;
        const weatherLine = `Messung bei: ${weatherText}`;

        // Store original remarks to restore after print
        originalRemarks = remarksTextarea.value;

        // Get current remarks text
        const currentRemarks = remarksTextarea.value.trim();

        // Add weather info if not already present
        if (!currentRemarks.includes(weatherLine)) {
          const newRemarks = currentRemarks ? `${currentRemarks}\n\n${weatherLine}` : weatherLine;
          remarksTextarea.value = newRemarks;
        }
      }

      // CSS @media print handles all the hiding, so we just need to trigger print
      // Small delay to ensure browser is ready
      setTimeout(() => {
        window.print();
        // Restore original remarks after print
        if (remarksTextarea && originalRemarks !== '') {
          remarksTextarea.value = originalRemarks;
        }
      }, 100);
    }

    // Tab switching functionality
    function switchTab(tabName) {
      // Hide all tab-content, remove active class from all buttons
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      // Show selected tab, add active class to button
      const tabContent = document.getElementById('tab-' + tabName);
      const tabBtn = document.getElementById(tabName + 'Btn');
      if (tabContent) tabContent.classList.add('active');
      if (tabBtn) tabBtn.classList.add('active');

      // Toggle action button visibility based on active tab
      const genBtn = document.getElementById('gen');
      const exportBtn = document.getElementById('exportPdf');
      const printBtn = document.getElementById('printProtocol');

      if (tabName === 'schaltplan') {
        genBtn.style.display = 'block';
        exportBtn.style.display = 'block';
        printBtn.style.display = 'none';
      } else if (tabName === 'protokoll') {
        genBtn.style.display = 'none';
        exportBtn.style.display = 'none';
        printBtn.style.display = 'block';
      }

      // If switching to protokoll tab, populate with current project data
      if (tabName === 'protokoll') {
        populateProtocolFromProject();
      }
    }

    // Populate protocol with project data
    function populateProtocolFromProject() {
      // Set customer address
      const customerTextarea = document.querySelector('.protocol-section > div[style*="grid-template-columns:1fr 1fr"] textarea');
      if (customerTextarea && window.state && window.state.projectAddress) {
        customerTextarea.value = window.state.projectAddress;
      }

      // Set module designation
      const moduleDesignationEl = document.getElementById('module-designation');
      if (moduleDesignationEl && window.state) {
        moduleDesignationEl.value = window.state.moduleConfig.info || 'Trina Vertex S+ TSM-NEG9R.28 460W';
      }

      // Add strings from solar areas
      addStringsFromSolarAreas();

      // Add inverters from project
      addInvertersFromProject();
    }

    // Add strings from solar areas to protocol
    function addStringsFromSolarAreas() {
      const tbody = document.getElementById('strings-tbody');
      if (!tbody || !window.state) return;

      // Clear existing rows
      tbody.innerHTML = '';

      // Add a row for each solar area
      window.state.solarAreas.forEach((sa, idx) => {
        const row = document.createElement('tr');
        row.id = 'protocol-string-' + sa.id;

        // Check if there's saved test data for this string
        const savedTest = window.state.protocol.stringTests?.find(test => test.name === sa.id);

        const isc = calculateIscForString();
        const uocValue = savedTest?.uoc || '';
        const rIsoValue = savedTest?.rIso || '> 200 MŒ©';
        const iscValue = savedTest?.isc || `${isc} A`;
        const modulesValue = savedTest?.modules || sa.modules;

        row.innerHTML = `
          <td><input type="text" value="${sa.id}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;font-weight:bold;box-sizing:border-box"></td>
          <td><input type="text" value="${modulesValue}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td><input type="text" value="${uocValue}" placeholder="V" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td><input type="text" value="${rIsoValue}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td><input type="text" value="${iscValue}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td style="text-align:center"><button class="protocol-btn-delete" onclick="removeProtocolString('${sa.id}')" style="padding:4px 8px;font-size:10px">√ó</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // Add inverters from project to protocol
    function addInvertersFromProject() {
      const tbody = document.getElementById('inverters-tbody');
      if (!tbody || !window.state) return;

      // Clear existing rows
      tbody.innerHTML = '';

      // Add a row for each inverter
      window.state.inverters.forEach((inv, idx) => {
        const row = document.createElement('tr');
        row.id = 'protocol-inverter-' + inv.id;

        // Check if there's saved test data for this inverter
        const savedTest = window.state.protocol.inverterTests?.find(test => test.name === inv.name);

        const impedanceValue = savedTest?.impedance || '';
        const rIsoValue = savedTest?.rIso || '> 200 MŒ©';
        const rLowValue = savedTest?.rLow || '< 1 Œ©';
        const statusValue = savedTest?.status || '‚úì i.O.';

        row.innerHTML = `
          <td><input type="text" value="${inv.name}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;font-weight:bold;box-sizing:border-box"></td>
          <td><input type="text" value="${impedanceValue}" placeholder="Œ©" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td><input type="text" value="${rIsoValue}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td><input type="text" value="${rLowValue}" style="width:100%;border:none;background:transparent;padding:2px;font-size:12px;box-sizing:border-box"></td>
          <td>${statusValue}</td>
          <td style="text-align:center"><button class="protocol-btn-delete" onclick="removeProtocolInverter('${inv.id}')" style="padding:4px 8px;font-size:10px">√ó</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    // Calculate Isc for strings (from protocol.html logic)
    function calculateIscForString() {
      const weatherSelect = document.getElementById('protocol-weather-condition');
      const iscRef = parseFloat(document.getElementById('protocol-isc-reference')?.value) || 10.8;

      const weatherData = {
        'sunny': { minPercent: 0.898, maxPercent: 1.0 },
        'cloudy': { minPercent: 0.398, maxPercent: 0.5 },
        'heavy-clouds': { minPercent: 0.204, maxPercent: 0.296 },
        'low-light': { minPercent: 0.046, maxPercent: 0.102 }
      };

      const selectedWeather = weatherData[weatherSelect ? weatherSelect.value : 'sunny'];
      const minIsc = iscRef * selectedWeather.minPercent;
      const maxIsc = iscRef * selectedWeather.maxPercent;
      const randomIsc = minIsc + Math.random() * (maxIsc - minIsc);

      return randomIsc.toFixed(1);
    }

    // Remove protocol string row
    function removeProtocolString(id) {
      const el = document.getElementById('protocol-string-' + id);
      if (el) el.remove();
    }

    // Remove protocol inverter row
    function removeProtocolInverter(id) {
      const el = document.getElementById('protocol-inverter-' + id);
      if (el) el.remove();
    }

    // Weather update function (from protocol.html)
    function updateWeatherInRemarks() {
      const remarksTextarea = document.getElementById('remarks-textarea');
      const weatherSelect = document.getElementById('protocol-weather-condition');

      const weatherData = {
        'sunny': { text: 'Volle Sonne (klarer Himmel)' },
        'cloudy': { text: 'Bew√∂lkt / diffuser Himmel' },
        'heavy-clouds': { text: 'Starke Bew√∂lkung / Schatten' },
        'low-light': { text: 'Sehr schwaches Licht / D√§mmerung' }
      };

      const selectedWeather = weatherData[weatherSelect.value];

      if (remarksTextarea && remarksTextarea.value.trim() === '') {
        remarksTextarea.value = `Messung bei: ${selectedWeather.text}`;
      }
    }

    // Simple client-side app
    (function(){
      // state - exposed globally as window.state for protocol functions
      window.state = {
        projectAddress: '', // Kundenanschrift
        slsSize: 35, // SLS-Schalter Gr√∂√üe (35A oder 50A)
        moduleConfig: {
          info: '', // Hersteller + Typ
          wattage: 455, // Nennleistung in W
          widthCm: 178, // Modulbreite in cm
          heightCm: 115 // Modulh√∂he in cm
        },
        mapPolygons: [], // Gespeicherte Kartenfl√§chen [{name, latlngs, areaM2, modules}]
        solarAreas: [],
        inverters: [],
        battery: null,
        meter: { id: 'Z1', name: 'Zweirichtungsz√§hler' },
        protocol: {
          customer: '',
          inspector: 'Betriebsadresse\nName\nTelefon',
          earthingValue: '8,9 Œ©',
          earthingStatus: '‚úì i.O.',
          checks: {
            markings: true,
            breaker: true,
            grounding: true,
            surge: true
          },
          moduleDesignation: '',
          weatherCondition: 'sunny',
          iscReference: 10.8,
          remarks: '',
          inverterTests: [],
          stringTests: []
        }
      };

      // helpers
      const $ = id => document.getElementById(id);

      // ID generator with dynamic starting point
      let uidCounter = 1;
      const uid = () => (uidCounter++).toString(36);

      // Function to update UID counter based on existing IDs
      function updateUidCounter() {
        let maxId = 0;

        // Check solar areas
        state.solarAreas.forEach(sa => {
          const match = sa.id.match(/^SA(.+)$/);
          if (match) {
            const idNum = parseInt(match[1], 36);
            if (!isNaN(idNum) && idNum >= maxId) {
              maxId = idNum + 1;
            }
          }
        });

        // Check inverters
        state.inverters.forEach(inv => {
          const match = inv.id.match(/^INV(.+)$/);
          if (match) {
            const idNum = parseInt(match[1], 36);
            if (!isNaN(idNum) && idNum >= maxId) {
              maxId = idNum + 1;
            }
          }
        });

        uidCounter = Math.max(uidCounter, maxId);
      }

      // DOM elems
      const saTable = $('saTable').querySelector('tbody');
      const invContainer = $('invContainer');
      const invAssign = $('invAssign');
      const batAssign = $('batAssign');

      // Calculation functions (aliased from js/calculations.js for local scope)
      const calculateNormalCurrent = window.calculateNominalCurrent;
      const calculateCableSize = window.calculateCableSize;
      const calculateCableSizeFromLsCurrent = window.calculateCableSizeFromLsCurrent;

      function renderLists(){
        // solarareas
        saTable.innerHTML=''; invAssign.innerHTML='';
        state.solarAreas.forEach(sa=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${sa.id}</td><td>${sa.name}</td><td>${sa.modules}</td><td>${(sa.modules*state.moduleConfig.wattage)/1000} kW</td><td><button class="danger btn-small" data-id="${sa.id}" title="L√∂schen">‚úï</button></td>`;
          saTable.appendChild(tr);
          invAssign.appendChild(new Option(`${sa.name} (${sa.id})`, sa.id));
        });
        // invs
        invContainer.innerHTML=''; batAssign.innerHTML=''; batAssign.appendChild(new Option('-- keiner --',''));
        state.inverters.forEach(inv=>{
          const card = document.createElement('div');
          card.className = 'card';
          const emergencyText = inv.emergencyPower ? 'Ja' : 'Nein';
          const emergencyIcon = inv.emergencyPower ? '‚ö°' : '';
          const assignedAreas = inv.assignedSolarAreaIds.length > 0 ? inv.assignedSolarAreaIds.join(', ') : 'Keine';
          card.innerHTML = `
            <div class="card-header">
              <span><strong>${inv.name}</strong> (${inv.id})</span>
              <span>${emergencyIcon}</span>
            </div>
            <div class="card-content">
              <div class="card-field">
                <div class="card-field-label">Phasen</div>
                <div class="card-field-value">${inv.phases}</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">AC-Leistung</div>
                <div class="card-field-value">${(inv.ac_power_w/1000).toFixed(2)} kW</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">LS-Schutz</div>
                <div class="card-field-value">${inv.ls_amps || 'N/A'} A</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Kabelquerschnitt</div>
                <div class="card-field-value">${inv.cable_size || 'N/A'} mm¬≤</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Notstrom</div>
                <div class="card-field-value">${emergencyText}</div>
              </div>
              <div class="card-field card-full-width">
                <div class="card-field-label">Zugeordnete Fl√§chen</div>
                <div class="card-field-value">${assignedAreas}</div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn-small" style="flex: 1" data-edit-id="${inv.id}" title="Bearbeiten">‚úèÔ∏è Bearbeiten</button>
              <button class="danger btn-small" style="flex: 1" data-delete-id="${inv.id}" title="L√∂schen">‚úï L√∂schen</button>
            </div>
          `;
          invContainer.appendChild(card);
          batAssign.appendChild(new Option(`${inv.name} (${inv.id})`, inv.id));
        });

        // Event-Handler f√ºr Bearbeiten und L√∂schen hinzuf√ºgen
        invContainer.querySelectorAll('button[data-edit-id]').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-edit-id');
          const inv = state.inverters.find(i => i.id === id);
          if(inv) {
            // Formular mit Werten f√ºllen
            $('invName').value = inv.name;
            $('invPhases').value = inv.phases;
            $('invAcW').value = inv.ac_power_w;
            $('invLsAmps').value = inv.ls_amps;
            $('invCableSize').value = inv.cable_size;
            $('invEmergencyPower').checked = inv.emergencyPower;
            // Zugewiesene Solarfl√§chen ausw√§hlen
            Array.from($('invAssign').options).forEach(option => {
              option.selected = inv.assignedSolarAreaIds.includes(option.value);
            });
            // Button-Text √§ndern und ID merken
            $('addInv').textContent = 'üîÑ Wechselrichter aktualisieren';
            $('addInv').setAttribute('data-editing-id', id);
            $('cancelEditInv').style.display = 'inline-block';
          }
        }));

        invContainer.querySelectorAll('button[data-delete-id]').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-delete-id');
          if(confirm('Wechselrichter l√∂schen?')) {
            state.inverters = state.inverters.filter(i => i.id !== id);
            renderLists();
            resetInverterForm();
          }
        }));

        // battery
        if(state.battery){
          $('batName').value = state.battery.name;
          $('batKwh').value = state.battery.kwh;
          $('batPowerKw').value = state.battery.power_kw ?? '';
          $('batAssign').value = state.battery.assignedInvId || '';
        }

        // attach delete handlers
        saTable.querySelectorAll('button').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-id'); state.solarAreas = state.solarAreas.filter(s=>s.id!==id);
          // remove references in inverters
          state.inverters.forEach(inv=>{ inv.assignedSolarAreaIds = inv.assignedSolarAreaIds.filter(x=>x!==id); });
          // remove linked polygon from map
          const polyIdx = _polygons.findIndex(p => p.solarAreaId === id);
          if (polyIdx !== -1) {
            if (_drawLayer) _drawLayer.removeLayer(_polygons[polyIdx].leafletLayer);
            _polygons.splice(polyIdx, 1);
            renderPolygonList();
          }
          renderLists();
        }));

        updateMetaBox();
      }

      function updateMetaBox(){
        const hasEmergencyPower = state.inverters.some(inv => inv.emergencyPower);
        $('metaBox').innerHTML = `PV-Fl√§chen: ${state.solarAreas.length} | Wechselrichter: ${state.inverters.length} | Batterie: ${state.battery? 'ja':'nein'} | Notstrom: ${hasEmergencyPower ? 'ja' : 'nein'}`;
      }

      // add solar area
      $('addSA').addEventListener('click', ()=>{
        const name = $('saName').value.trim();
        const modules = parseInt($('saCount').value,10);
        if(!name){return alert('Name ist Pflicht');}
        if(!modules || modules<1) return alert('Anzahl Module muss >=1 sein');
        if(!state.moduleConfig.wattage || state.moduleConfig.wattage<=0) return alert('Modul Nennleistung muss in der PV-Module Konfiguration eingetragen werden');
        const id = 'SA'+uid();
        state.solarAreas.push({id,name,modules});
        $('saName').value=''; $('saCount').value=10;
        renderLists();
      });

      // add/edit inverter
      $('addInv').addEventListener('click', ()=>{
        const editingId = $('addInv').getAttribute('data-editing-id');
        const name = $('invName').value.trim()||'WR';
        const phases = $('invPhases').value;
        const ac_power_w = parseFloat($('invAcW').value)||0;
        const ls_amps = parseInt($('invLsAmps').value)||25;
        const cable_size = parseFloat($('invCableSize').value)||4;
        const emergencyPower = $('invEmergencyPower').checked || false;
        const assigned = Array.from($('invAssign').selectedOptions).map(o=>o.value);
        if(editingId) {
          // Bearbeiten-Modus: vorhandenen Wechselrichter aktualisieren
          const inv = state.inverters.find(i => i.id === editingId);
          if(inv) {
            inv.name = name;
            inv.phases = phases;
            inv.ac_power_w = ac_power_w;
            inv.ls_amps = ls_amps;
            inv.cable_size = cable_size;
            inv.emergencyPower = emergencyPower;
            inv.assignedSolarAreaIds = assigned;
          }
          resetInverterForm();
        } else {
          // Normaler Hinzuf√ºgen-Modus
          const id = 'INV'+uid();
          state.inverters.push({id,name,phases,ac_power_w,ls_amps,cable_size,emergencyPower,assignedSolarAreaIds:assigned,assignedBatteryId:null});
          resetInverterForm();
        }
        renderLists();
      });

      // cancel edit inverter
      $('cancelEditInv').addEventListener('click', ()=>{
        resetInverterForm();
      });

      // Hilfsfunktion zum Zur√ºcksetzen des Wechselrichter-Formulars
      function resetInverterForm() {
        $('invName').value='';
        $('invAcW').value=5000;
        $('invLsAmps').value=25;
        $('invCableSize').value=4;
        $('invEmergencyPower').checked=false;
        $('invAssign').selectedIndex=-1;
        $('addInv').textContent = '‚ûï Wechselrichter hinzuf√ºgen';
        $('addInv').removeAttribute('data-editing-id');
        $('cancelEditInv').style.display = 'none';
      }

      // battery
      $('addBat').addEventListener('click', ()=>{
        const name = $('batName').value.trim()||'BAT';
        const kwh = parseFloat($('batKwh').value)||0;
        const power_kw = parseFloat($('batPowerKw').value)||0;
        const assignedInvId = $('batAssign').value||null;
        if(!state.battery) state.battery = { id:'BAT1', name, kwh, power_kw, assignedInvId };
        else { state.battery.name = name; state.battery.kwh = kwh; state.battery.power_kw = power_kw; state.battery.assignedInvId = assignedInvId; }
        renderLists();
      });
      $('removeBat').addEventListener('click', ()=>{ state.battery=null; renderLists(); });

      // project controls
      $('newProject').addEventListener('click', ()=>{
        if(!confirm('Neues Projekt erstellen? Alle nicht gespeicherten √Ñnderungen gehen verloren.')) return;
        collapseAllExceptFirst();
        state.moduleConfig = { info: '', wattage: 420, widthCm: 178, heightCm: 115 };
        state.mapPolygons = [];
        state.solarAreas=[]; state.inverters=[]; state.battery=null;
        uidCounter = 1; // Reset counter for new project
        _polygons = []; if(_drawLayer) _drawLayer.clearLayers(); renderPolygonList();
        renderLists();
        $('moduleInfo').value='';
        $('moduleWattage').value=420;
        $('moduleWidthCm').value=178;
        $('moduleHeightCm').value=115;
        $('svgWrap').innerHTML='Keine Vorschau. Bitte ‚ÄûSchaltplan generieren‚Äú klicken.';

      });

      $('projectAddress').addEventListener('input',(e)=>{ state.projectAddress = e.target.value; });

      $('slsSize').addEventListener('change',(e)=>{ state.slsSize = Number(e.target.value); });

      // module config listeners
      $('moduleInfo').addEventListener('input',(e)=>{ state.moduleConfig.info = e.target.value; renderLists(); });

      // Auto-calculate LS suggestion when AC power or phases change
      function updateLsSuggestion() {
        const acPowerW = parseFloat($('invAcW').value) || 0;
        const phases = $('invPhases').value;
        if (acPowerW > 0) {
          const lsSuggestion = calculateNormalCurrent(acPowerW, phases);
          $('invLsAmps').value = lsSuggestion;
          $('invLsAmps').style.backgroundColor = '#e8f5e8'; // Light green to indicate auto-calculated

          setTimeout(() => {
            $('invLsAmps').style.backgroundColor = '';
          }, 500);

          // Trigger cable suggestion update based on new LS value
          updateCableSuggestion();
        }
      }

      // Auto-calculate cable suggestion when LS current changes
      function updateCableSuggestion() {
        const lsAmps = parseInt($('invLsAmps').value) || 0;
        if (lsAmps > 0) {
          const cableSuggestion = calculateCableSizeFromLsCurrent(lsAmps);
          $('invCableSize').value = cableSuggestion;
          $('invCableSize').style.backgroundColor = '#e8f5e8'; // Light green to indicate auto-calculated

          setTimeout(() => {
            $('invCableSize').style.backgroundColor = '';
          }, 500);
        }
      }

      $('invAcW').addEventListener('input', updateLsSuggestion);
      $('invPhases').addEventListener('change', updateLsSuggestion);
      $('invLsAmps').addEventListener('input', updateCableSuggestion);
      $('moduleWattage').addEventListener('input',(e)=>{
        state.moduleConfig.wattage = parseFloat(e.target.value) || 420;
        renderLists();
      });
      $('moduleWidthCm').addEventListener('input',(e)=>{ state.moduleConfig.widthCm = parseFloat(e.target.value) || 178; });
      $('moduleHeightCm').addEventListener('input',(e)=>{ state.moduleConfig.heightCm = parseFloat(e.target.value) || 115; });

      // Capture protocol data to state
      function captureProtocolData() {
        if (!state.protocol) return;

        // Basic fields
        const customer = $('protocol-customer');
        const inspector = $('protocol-inspector');
        const earthingValue = $('protocol-earthing-value');
        const earthingStatus = $('protocol-earthing-status');
        const moduleDesignation = $('module-designation');
        const weatherCondition = $('protocol-weather-condition');
        const iscReference = $('protocol-isc-reference');
        const remarks = $('remarks-textarea');

        if (customer) state.protocol.customer = customer.value;
        if (inspector) state.protocol.inspector = inspector.value;
        if (earthingValue) state.protocol.earthingValue = earthingValue.value;
        if (earthingStatus) state.protocol.earthingStatus = earthingStatus.value;
        if (moduleDesignation) state.protocol.moduleDesignation = moduleDesignation.value;
        if (weatherCondition) state.protocol.weatherCondition = weatherCondition.value;
        if (iscReference) state.protocol.iscReference = parseFloat(iscReference.value) || 10.8;
        if (remarks) state.protocol.remarks = remarks.value;

        // Checkboxes
        state.protocol.checks.markings = $('protocol-check-markings')?.checked || true;
        state.protocol.checks.breaker = $('protocol-check-breaker')?.checked || true;
        state.protocol.checks.grounding = $('protocol-check-grounding')?.checked || true;
        state.protocol.checks.surge = $('protocol-check-surge')?.checked || true;

        // Inverter tests - collect from table
        state.protocol.inverterTests = [];
        const invertersTbody = document.getElementById('inverters-tbody');
        if (invertersTbody) {
          const rows = invertersTbody.querySelectorAll('tr');
          rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
              state.protocol.inverterTests.push({
                name: inputs[0]?.value || '',
                impedance: inputs[1]?.value || '',
                rIso: inputs[2]?.value || '',
                rLow: inputs[3]?.value || '',
                status: inputs[4]?.value || ''
              });
            }
          });
        }

        // String tests - collect from table
        state.protocol.stringTests = [];
        const stringsTbody = document.getElementById('strings-tbody');
        if (stringsTbody) {
          const rows = stringsTbody.querySelectorAll('tr');
          rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length >= 4) {
              state.protocol.stringTests.push({
                name: inputs[0]?.value || '',
                modules: inputs[1]?.value || '',
                uoc: inputs[2]?.value || '',
                rIso: inputs[3]?.value || '',
                isc: inputs[4]?.value || ''
              });
            }
          });
        }
      }

      // Restore protocol data from state
      function restoreProtocolData() {
        if (!state.protocol) return;

        const customer = $('protocol-customer');
        const inspector = $('protocol-inspector');
        const earthingValue = $('protocol-earthing-value');
        const earthingStatus = $('protocol-earthing-status');
        const moduleDesignation = $('module-designation');
        const weatherCondition = $('protocol-weather-condition');
        const iscReference = $('protocol-isc-reference');
        const remarks = $('remarks-textarea');

        if (customer) customer.value = state.protocol.customer || '';
        if (inspector) inspector.value = state.protocol.inspector || 'Betriebsadresse\nName\nTelefon';
        if (earthingValue) earthingValue.value = state.protocol.earthingValue || '8,9 Œ©';
        if (earthingStatus) earthingStatus.value = state.protocol.earthingStatus || '‚úì i.O.';
        if (moduleDesignation) moduleDesignation.value = state.protocol.moduleDesignation || '';
        if (weatherCondition) weatherCondition.value = state.protocol.weatherCondition || 'sunny';
        if (iscReference) iscReference.value = state.protocol.iscReference || 10.8;
        if (remarks) remarks.value = state.protocol.remarks || '';

        // Restore checkboxes
        const markingsCheck = $('protocol-check-markings');
        const breakerCheck = $('protocol-check-breaker');
        const groundingCheck = $('protocol-check-grounding');
        const surgeCheck = $('protocol-check-surge');

        if (markingsCheck) markingsCheck.checked = state.protocol.checks.markings;
        if (breakerCheck) breakerCheck.checked = state.protocol.checks.breaker;
        if (groundingCheck) groundingCheck.checked = state.protocol.checks.grounding;
        if (surgeCheck) surgeCheck.checked = state.protocol.checks.surge;

        // Note: Inverter and string tests are dynamically generated,
        // so we'll restore them through populateProtocolFromProject
      }

      // save/load
      $('saveProject').addEventListener('click', ()=>{
        captureProtocolData();
        captureMapPolygons();
        state.slsSize = Number($('slsSize').value) || 35;
        const blob = new Blob([JSON.stringify({projectAddress:state.projectAddress,slsSize:state.slsSize,moduleConfig:state.moduleConfig,mapPolygons:state.mapPolygons,solarAreas:state.solarAreas,inverters:state.inverters,battery:state.battery,protocol:state.protocol},null,2)],{type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'stromlaufplan.pvproj.json'; a.click();
      });

      $('openProject').addEventListener('click', ()=>{
        $('loadFile').click();
      });

      $('loadFile').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return; const txt = await f.text();
        try{
          const obj = JSON.parse(txt);
          state.projectAddress = obj.projectAddress||'';
          state.slsSize = obj.slsSize || 35;
          state.moduleConfig = obj.moduleConfig||{ info: '', wattage: 420 };
          state.solarAreas = obj.solarAreas||[];
          state.inverters = obj.inverters||[];
          state.battery = obj.battery||null;
          state.mapPolygons = obj.mapPolygons || [];
          if (obj.protocol) {
            state.protocol = obj.protocol;
          }
          collapseAllExceptFirst();
          $('projectAddress').value = state.projectAddress;
          $('slsSize').value = state.slsSize;
          state.moduleConfig.widthCm ||= 178;
          state.moduleConfig.heightCm ||= 115;
          $('moduleInfo').value = state.moduleConfig.info;
          $('moduleWattage').value = state.moduleConfig.wattage;
          $('moduleWidthCm').value = state.moduleConfig.widthCm;
          $('moduleHeightCm').value = state.moduleConfig.heightCm;
          updateUidCounter(); // Update counter based on loaded IDs
          renderLists();
          // Restore protocol data
          restoreProtocolData();
          // Restore map polygons if map is already initialized
          if (_leafletMap) _restorePolygonsFromState();
        }catch(err){ alert('Fehler beim Laden: '+err.message); }
      });

      async function renderPreview(){
        if(state.solarAreas.length===0 && state.inverters.length===0){ alert('F√ºge mindestens eine Solarfl√§che oder einen Wechselrichter hinzu.'); return; }

        try{
          // Generate professional electrical schematic
          const svg = buildProfessionalSVG();

          // put svg into preview
          const wrap = $('svgWrap');
          wrap.innerHTML = '';
          wrap.appendChild(svg);
        }catch(err){
          alert('Fehler bei Schaltplan-Generierung: '+err.message);
          console.error(err);
        }
      }



      $('gen').addEventListener('click', ()=>{ renderPreview(); });

      // Professional PDF export (A4 landscape) with enhanced layout
      $('exportPdf').addEventListener('click', async ()=>{
        const svgEl = $('svgWrap').querySelector('svg');
        if(!svgEl) return alert('SVG nicht gefunden');

        try{
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

          // A4 landscape dimensions in mm
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Nur SVG: seitenf√ºllend (fit-to-page, keine R√§nder)
          const svgClone = svgEl.cloneNode(true);
          svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

          // 1) <use>-Elemente inline expandieren, damit nichts abgeschnitten wird
          (function inlineUse(root){
            const uses = Array.from(root.querySelectorAll('use'));
            uses.forEach(use => {
              const href = use.getAttribute('href') || use.getAttributeNS('http://www.w3.org/1999/xlink','href');
              if(!href || !href.startsWith('#')) return;
              const id = href.slice(1);
              const def = svgClone.querySelector(`#${CSS.escape(id)}`);
              if(!def) return;
              const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
              // Transform √ºbernehmen
              const tf = use.getAttribute('transform');
              if(tf) g.setAttribute('transform', tf);
              // Inhalt klonen
              const cloned = def.cloneNode(true);
              // id entfernen, um Duplikate zu vermeiden
              cloned.removeAttribute('id');
              g.appendChild(cloned);
              // use ersetzen
              use.replaceWith(g);
            });
          })(svgClone);

          // 2) BBox korrekt ermitteln: tempor√§r in DOM einf√ºgen, viewBox setzen
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'fixed';
          tempContainer.style.left = '-10000px';
          tempContainer.style.top = '-10000px';
          document.body.appendChild(tempContainer);
          tempContainer.appendChild(svgClone);
          try {
            const bbox = svgClone.getBBox();
            if(bbox && isFinite(bbox.x) && isFinite(bbox.y) && isFinite(bbox.width) && isFinite(bbox.height) && bbox.width>0 && bbox.height>0){
              const pad = 2;
              const vbX = bbox.x - pad;
              const vbY = bbox.y - pad;
              const vbW = bbox.width + 2*pad;
              const vbH = bbox.height + 2*pad;
              svgClone.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`);
              svgClone.removeAttribute('width');
              svgClone.removeAttribute('height');
            }
          } finally {
            // im DOM belassen, bis svg2pdf gerendert hat (damit Styles/BBox stabil bleiben)
          }
          // SVG-Logikgr√∂√üe bestimmen
          let vb = svgClone.viewBox && svgClone.viewBox.baseVal;
          let svgW = (vb && vb.width) ? vb.width : parseFloat(svgClone.getAttribute('width')) || 1000;
          let svgH = (vb && vb.height) ? vb.height : parseFloat(svgClone.getAttribute('height')) || 700;

          // Fit-to-page Skalierung (Seite komplett ausnutzen, Seitenverh√§ltnis beibehalten)
          const scale = Math.min(pageWidth / svgW, pageHeight / svgH);
          const drawW = svgW * scale;
          const drawH = svgH * scale;
          const xOffset = (pageWidth - drawW) / 2;
          const yOffset = (pageHeight - drawH) / 2;

          // Nur SVG in PDF rendern
          await window.svg2pdf.svg2pdf(svgClone, pdf, {
            xOffset,
            yOffset,
            scale
          });
          // tempor√§ren Knoten entfernen
          if(tempContainer && tempContainer.parentNode){
            tempContainer.parentNode.removeChild(tempContainer);
          }

          pdf.save('Stromlaufplan.pdf');
        }catch(err){
          alert('PDF Export fehlgeschlagen: '+err.message);
          console.error(err);
        }
      });

      // initial render
      $('moduleInfo').value = state.moduleConfig.info;
      $('moduleWattage').value = state.moduleConfig.wattage;
      $('moduleWidthCm').value = state.moduleConfig.widthCm;
      $('moduleHeightCm').value = state.moduleConfig.heightCm;
      renderLists();

      // Set initial LS and cable suggestions
      updateLsSuggestion();

      // Add event listener for print protocol button
      $('printProtocol').addEventListener('click', printProtocol);

      // Set today's date as default for protocol test date
      const today = new Date();
      const dateStr = today.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      document.getElementById('protocol-test-date').value = dateStr;

      // ‚îÄ‚îÄ Map Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let _leafletMap = null;
      let _drawLayer  = null;
      let _polygons   = []; // [{leafletLayer, areaM2, modules, name}]
      let _polygonCounter = 0;
      let _editingEntry = null;

      function captureMapPolygons() {
        state.mapPolygons = _polygons.map(entry => ({
          name: entry.name,
          latlngs: entry.leafletLayer.getLatLngs()[0].map(ll => ({ lat: ll.lat, lng: ll.lng })),
          areaM2: entry.areaM2,
          modules: entry.modules
        }));
      }

      function _restorePolygonsFromState() {
        if (!state.mapPolygons || state.mapPolygons.length === 0) return;
        _drawLayer.clearLayers();
        _polygons = [];
        state.mapPolygons.forEach(saved => {
          const latlngs = saved.latlngs.map(ll => L.latLng(ll.lat, ll.lng));
          const layer = L.polygon(latlngs);
          _drawLayer.addLayer(layer);
          const recalc = window.calculateModulesInPolygon(saved.latlngs, state.moduleConfig.widthCm, state.moduleConfig.heightCm);
          const entry = { leafletLayer: layer, areaM2: saved.areaM2, modules: recalc || saved.modules, name: saved.name };
          _polygons.push(entry);
          layer.bindPopup(buildPopupContent(entry));
        });
        renderPolygonList();
        if (_polygons.length > 0) {
          _leafletMap.fitBounds(_drawLayer.getBounds(), { padding: [20, 20] });
        }
      }

      function openMapModal() {
        $('mapModal').style.display = 'block';
        // Pre-fill search from project address
        if (state.projectAddress && !$('mapSearch').value) {
          const firstLine = state.projectAddress.split('\n').filter(l => l.trim()).slice(-2).join(', ');
          $('mapSearch').value = firstLine;
        }
        if (!_leafletMap) {
          _initLeafletMap();
          if ($('mapSearch').value) searchAddress($('mapSearch').value);
        } else {
          setTimeout(() => _leafletMap.invalidateSize(), 100);
        }
      }

      function closeMapModal() {
        $('mapModal').style.display = 'none';
      }

      function _initLeafletMap() {
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 22
        });
        const satelliteLayer = L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          { attribution: 'Tiles ¬© Esri', maxZoom: 22 }
        );

        _leafletMap = L.map('leafletMap', { layers: [satelliteLayer] }).setView([51.1657, 10.4515], 6);

        L.control.layers(
          { 'Satellit': satelliteLayer, 'OpenStreetMap': osmLayer },
          {},
          { position: 'topright' }
        ).addTo(_leafletMap);

        _drawLayer = new L.FeatureGroup();
        _leafletMap.addLayer(_drawLayer);

        const drawControl = new L.Control.Draw({
          draw: {
            polygon: { allowIntersection: false, showArea: true },
            polyline: false,
            rectangle: false,
            circle: false,
            circlemarker: false,
            marker: false
          },
          edit: { featureGroup: _drawLayer }
        });
        _leafletMap.addControl(drawControl);

        _leafletMap.on(L.Draw.Event.CREATED, function(e) {
          const layer = e.layer;
          const areaM2 = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
          const modules = window.calculateModulesInPolygon(layer.getLatLngs()[0], state.moduleConfig.widthCm, state.moduleConfig.heightCm);
          _polygonCounter++;
          const entry = {
            leafletLayer: layer,
            areaM2: areaM2,
            modules: modules,
            name: 'Dach ' + _polygonCounter
          };
          _polygons.push(entry);
          _drawLayer.addLayer(layer);
          layer.bindPopup(buildPopupContent(entry)).openPopup();
          renderPolygonList();
        });

        _leafletMap.on(L.Draw.Event.EDITED, function(e) {
          e.layers.eachLayer(function(layer) {
            const entry = _polygons.find(p => p.leafletLayer === layer);
            if (entry) {
              entry.areaM2 = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
              entry.modules = window.calculateModulesInPolygon(layer.getLatLngs()[0], state.moduleConfig.widthCm, state.moduleConfig.heightCm);
              layer.setPopupContent(buildPopupContent(entry));
            }
          });
          renderPolygonList();
        });

        _leafletMap.on(L.Draw.Event.DELETED, function(e) {
          e.layers.eachLayer(function(layer) {
            _polygons = _polygons.filter(p => p.leafletLayer !== layer);
          });
          renderPolygonList();
        });

        // Restore polygons from state (e.g. after project load)
        _restorePolygonsFromState();
      }

      function buildPopupContent(entry) {
        return `<b>${entry.name}</b><br>Fl√§che: ${entry.areaM2.toFixed(1)} m¬≤<br>Module: ca. ${entry.modules}`;
      }

      function startEditing(entry) {
        if (_editingEntry && _editingEntry !== entry) {
          stopEditing(_editingEntry);
        }
        entry.leafletLayer.editing.enable();
        _editingEntry = entry;
        _leafletMap.fitBounds(entry.leafletLayer.getBounds(), { padding: [60, 60] });
        renderPolygonList();
      }

      function stopEditing(entry) {
        entry.leafletLayer.editing.disable();
        entry.areaM2 = L.GeometryUtil.geodesicArea(entry.leafletLayer.getLatLngs()[0]);
        entry.modules = window.calculateModulesInPolygon(entry.leafletLayer.getLatLngs()[0], state.moduleConfig.widthCm || 178, state.moduleConfig.heightCm || 115);
        entry.leafletLayer.setPopupContent(buildPopupContent(entry));
        _editingEntry = null;
        renderPolygonList();
      }

      async function searchAddress(query) {
        if (!query.trim()) return;
        $('mapSearchStatus').textContent = 'Suche l√§uft‚Ä¶';
        try {
          const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
          const res = await fetch(url, { headers: { 'Accept-Language': 'de' } });
          const data = await res.json();
          if (data && data.length > 0) {
            const { lat, lon, display_name } = data[0];
            _leafletMap.setView([parseFloat(lat), parseFloat(lon)], 19);
            $('mapSearchStatus').textContent = '‚úì ' + display_name;
          } else {
            $('mapSearchStatus').textContent = 'Adresse nicht gefunden.';
          }
        } catch(err) {
          $('mapSearchStatus').textContent = 'Fehler bei der Suche: ' + err.message;
        }
      }

      async function autofillBuildings() {
        if (!_leafletMap) return;
        const btn = $('mapAutofillBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ L√§dt‚Ä¶';
        $('mapSearchStatus').textContent = 'Geb√§ude werden von OpenStreetMap geladen‚Ä¶';
        try {
          const center = _leafletMap.getCenter();
          const lat = center.lat, lon = center.lng;

          const query = `[out:json][timeout:15];way["building"](around:80,${lat},${lon});out geom;`;
          const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Overpass-API Fehler: ' + res.status);
          const data = await res.json();

          if (!data.elements || data.elements.length === 0) {
            $('mapSearchStatus').textContent = '‚ö† Kein Geb√§ude gefunden. Karte auf das Geb√§ude zentrieren und erneut versuchen.';
            return;
          }

          // Prefer buildings that contain the map center; fallback to all found
          function containsCenter(geom) {
            let inside = false;
            for (let i = 0, j = geom.length - 1; i < geom.length; j = i++) {
              const xi = geom[i].lon, yi = geom[i].lat;
              const xj = geom[j].lon, yj = geom[j].lat;
              if ((yi > lat) !== (yj > lat) && lon < (xj - xi) * (lat - yi) / (yj - yi) + xi)
                inside = !inside;
            }
            return inside;
          }

          let candidates = data.elements.filter(el => el.type === 'way' && el.geometry && el.geometry.length >= 3);
          const hits = candidates.filter(el => containsCenter(el.geometry));
          if (hits.length > 0) candidates = hits;

          let added = 0;
          candidates.forEach(el => {
            const latlngs = el.geometry.map(pt => L.latLng(pt.lat, pt.lon));
            const layer = L.polygon(latlngs, { color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.25 });
            _drawLayer.addLayer(layer);
            const latlngsArr = el.geometry.map(pt => ({ lat: pt.lat, lng: pt.lon }));
            const areaM2 = L.GeometryUtil.geodesicArea(latlngs);
            const modules = window.calculateModulesInPolygon(latlngsArr, state.moduleConfig.widthCm || 178, state.moduleConfig.heightCm || 115);
            _polygonCounter++;
            const entry = { leafletLayer: layer, areaM2, modules, name: 'Dach ' + _polygonCounter };
            _polygons.push(entry);
            layer.bindPopup(buildPopupContent(entry));
            added++;
          });

          $('mapSearchStatus').textContent = `‚úì ${added} Geb√§ude erkannt (OSM). Fl√§chen anpassen und √ºbernehmen.`;
          renderPolygonList();
          if (_drawLayer.getLayers().length > 0)
            _leafletMap.fitBounds(_drawLayer.getBounds(), { padding: [30, 30] });
        } catch(err) {
          $('mapSearchStatus').textContent = 'Fehler: ' + err.message;
        } finally {
          btn.disabled = false;
          btn.textContent = 'üè† Geb√§ude erkennen';
        }
      }

      function renderPolygonList() {
        const container = $('mapPolygonList');
        if (!container) return;
        if (_polygons.length === 0) {
          container.innerHTML = '<p style="font-size:12px;color:#999;">Noch keine Polygone gezeichnet.</p>';
          return;
        }
        container.innerHTML = _polygons.map((entry, idx) => `
          <div style="display:flex;align-items:center;gap:8px;padding:6px;background:${entry.solarAreaId ? '#f0fdf4' : '#f8fafc'};border:1px solid ${entry.solarAreaId ? '#86efac' : '#e2e8f0'};border-radius:6px;margin-bottom:6px;">
            <span style="font-size:12px;color:#666;min-width:20px;">${idx+1}.</span>
            <input type="text" value="${entry.name}" data-pidx="${idx}" style="flex:1;padding:4px 6px;font-size:12px;" />
            <span style="font-size:12px;color:#555;white-space:nowrap;">${entry.areaM2.toFixed(0)} m¬≤ ¬∑ ${entry.modules} Module</span>
            <button data-edit="${idx}" style="font-size:11px;padding:4px 8px;${entry === _editingEntry ? 'background:#dcfce7;border-color:#86efac;color:#15803d;font-weight:bold;' : 'background:#f1f5f9;border-color:#cbd5e1;color:#64748b;'}">${entry === _editingEntry ? '‚úì Fertig' : '‚úè Bearbeiten'}</button>
            ${entry.solarAreaId
              ? `<button data-remove="${idx}" style="font-size:11px;padding:4px 8px;background:#fee2e2;border-color:#fca5a5;color:#b91c1c;">‚úï Entfernen</button>`
              : `<button data-import="${idx}" style="font-size:11px;padding:4px 8px;">Als Solarfl√§che √ºbernehmen</button>`
            }
            <button data-delete="${idx}" style="font-size:11px;padding:4px 6px;background:#f1f5f9;border-color:#cbd5e1;color:#64748b;" title="Polygon l√∂schen">üóë</button>
          </div>
        `).join('');
        container.querySelectorAll('input[data-pidx]').forEach(input => {
          input.addEventListener('change', function() {
            const idx = parseInt(this.getAttribute('data-pidx'));
            _polygons[idx].name = this.value;
            _polygons[idx].leafletLayer.setPopupContent(buildPopupContent(_polygons[idx]));
          });
        });
        container.querySelectorAll('button[data-import]').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.getAttribute('data-import'));
            importPolygonAsSolarArea(_polygons[idx]);
          });
        });
        container.querySelectorAll('button[data-edit]').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.getAttribute('data-edit'));
            const entry = _polygons[idx];
            entry === _editingEntry ? stopEditing(entry) : startEditing(entry);
          });
        });
        container.querySelectorAll('button[data-remove]').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.getAttribute('data-remove'));
            const entry = _polygons[idx];
            state.solarAreas = state.solarAreas.filter(sa => sa.id !== entry.solarAreaId);
            entry.solarAreaId = null;
            if (entry.leafletLayer.setStyle)
              entry.leafletLayer.setStyle({ color: '#3388ff', fillColor: '#3388ff', fillOpacity: 0.2 });
            entry.leafletLayer.setPopupContent(buildPopupContent(entry));
            renderLists();
            renderPolygonList();
          });
        });
        container.querySelectorAll('button[data-delete]').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.getAttribute('data-delete'));
            const entry = _polygons[idx];
            if (entry.solarAreaId) {
              state.solarAreas = state.solarAreas.filter(sa => sa.id !== entry.solarAreaId);
              renderLists();
            }
            _drawLayer.removeLayer(entry.leafletLayer);
            _polygons.splice(idx, 1);
            renderPolygonList();
          });
        });
      }

      function importPolygonAsSolarArea(entry) {
        if (!entry.modules || entry.modules < 1) {
          alert('Zu wenige Module berechnet. Bitte eine gr√∂√üere Fl√§che zeichnen oder Modulabmessungen pr√ºfen.');
          return;
        }
        const id = 'SA' + uid();
        entry.solarAreaId = id; // Link polygon ‚Üî solar area
        state.solarAreas.push({ id, name: entry.name, modules: entry.modules });
        renderLists();
        // Mark polygon green as visual feedback
        if (entry.leafletLayer.setStyle) {
          entry.leafletLayer.setStyle({ color: '#16a34a', fillColor: '#16a34a' });
        }
        entry.leafletLayer.setPopupContent(buildPopupContent(entry) + '<br><span style="color:green;font-weight:bold;">‚úì √úbernommen als ' + id + '</span>');
        renderPolygonList();
      }

      $('openMapModal').addEventListener('click', openMapModal);
      $('mapModalClose').addEventListener('click', closeMapModal);
      $('mapModal').addEventListener('click', function(e) {
        if (e.target === this) closeMapModal();
      });
      $('mapSearchBtn').addEventListener('click', () => searchAddress($('mapSearch').value));
      $('mapAutofillBtn').addEventListener('click', autofillBuildings);

      function openCalcModal() {
        $('calcModW').value = state.moduleConfig.widthCm || 178;
        $('calcModH').value = state.moduleConfig.heightCm || 115;
        $('calcModal').style.display = 'block';
        updateCalcResult();
      }

      function updateCalcResult() {
        const lengthM = parseFloat($('calcLength').value) || 0;
        const widthM  = parseFloat($('calcWidth').value)  || 0;
        const modW    = parseFloat($('calcModW').value)   || 178;
        const modH    = parseFloat($('calcModH').value)   || 115;

        if (lengthM <= 0 || widthM <= 0) {
          $('calcResult').innerHTML = '<p style="color:#999;font-size:13px;">Bitte L√§nge und Breite eingeben.</p>';
          return;
        }

        const r = window.calculateModulesForRect(lengthM, widthM, modW, modH);
        const better = r.portrait >= r.landscape ? 'portrait' : 'landscape';

        $('calcResult').innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="background:#f1f5f9;">
                <th style="padding:8px;text-align:left;border-bottom:2px solid #e2e8f0;">Ausrichtung</th>
                <th style="padding:8px;text-align:center;border-bottom:2px solid #e2e8f0;">Reihen √ó Spalten</th>
                <th style="padding:8px;text-align:center;border-bottom:2px solid #e2e8f0;">Module</th>
              </tr>
            </thead>
            <tbody>
              <tr style="${better==='portrait' ? 'background:#f0fdf4;font-weight:600;' : ''}">
                <td style="padding:8px;border-bottom:1px solid #f0f2fa;">Hochformat</td>
                <td style="padding:8px;text-align:center;border-bottom:1px solid #f0f2fa;">${r.portraitRows} √ó ${r.portraitCols}</td>
                <td style="padding:8px;text-align:center;border-bottom:1px solid #f0f2fa;">${r.portrait}${better==='portrait' ? ' ‚úì' : ''}</td>
              </tr>
              <tr style="${better==='landscape' ? 'background:#f0fdf4;font-weight:600;' : ''}">
                <td style="padding:8px;">Querformat</td>
                <td style="padding:8px;text-align:center;">${r.landscapeRows} √ó ${r.landscapeCols}</td>
                <td style="padding:8px;text-align:center;">${r.landscape}${better==='landscape' ? ' ‚úì' : ''}</td>
              </tr>
            </tbody>
          </table>
          <p style="font-size:11px;color:#888;margin-top:8px;">
            Fl√§che: ${lengthM} √ó ${widthM} m = ${(lengthM*widthM).toFixed(1)} m¬≤  ¬∑  Modul: ${modW} √ó ${modH} cm
          </p>
        `;
      }

      $('openCalcModal').addEventListener('click', openCalcModal);
      $('calcModalClose').addEventListener('click', () => $('calcModal').style.display = 'none');
      $('calcModal').addEventListener('click', e => { if (e.target === $('calcModal')) $('calcModal').style.display = 'none'; });
      ['calcLength','calcWidth','calcModW','calcModH'].forEach(id => $(id).addEventListener('input', updateCalcResult));
      $('mapSearch').addEventListener('keydown', (e) => { if (e.key === 'Enter') searchAddress($('mapSearch').value); });

    })();

  </script>

</body>
</html>
