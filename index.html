<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PV Schaltplan Generator</title>
  <style>
    :root{--accent:#1f6feb;--muted:#666}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:0;height:100vh;display:flex;gap:12px}
    header{padding:10px 14px;background:#f4f6fb;border-bottom:1px solid #e6e9f2}
    .sidebar{width:380px;min-width:360px;padding:12px;box-sizing:border-box;overflow-y:auto;overflow-x:hidden;border-right:1px solid #eceef6}
    .main{flex:1;display:flex;flex-direction:column;gap:8px;padding:12px;box-sizing:border-box;min-height:0}
    h2{margin:6px 0}
    label{display:block;margin-top:8px;font-size:13px}
    input,select{width:100%;max-width:100%;padding:8px;margin-top:4px;border:1px solid #d8dbe9;border-radius:6px;box-sizing:border-box}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;max-width:100%;box-sizing:border-box;min-height:36px;font-size:13px;transition:all 0.2s ease}
    button:hover{background:#1454d6;transform:translateY(-1px)}
    .danger{background:#dc2626;color:#fff;border:1px solid #b91c1c;text-shadow:0 0 3px rgba(0,0,0,0.8)}
    .danger:hover{background:#b91c1c;border-color:#991b1b}
    .btn-small{padding:4px 8px;min-height:auto;font-size:11px}
    .btn-small[title]{padding:4px 6px;min-width:28px;font-size:14px;text-shadow:0 0 2px rgba(0,0,0,0.5)}
    .muted{color:var(--muted);font-size:13px}
    .list{margin-top:8px;border-top:1px dashed #e3e6f2;padding-top:8px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:6px;text-align:left;border-bottom:1px solid #f0f2fa;font-size:13px;word-wrap:break-word;overflow:hidden}
    /* Spezifische Spaltenbreiten für Solarflächen-Tabelle */
    #saTable{table-layout:fixed}
    #saTable th:nth-child(1),#saTable td:nth-child(1){width:25px}
    #saTable th:nth-child(2),#saTable td:nth-child(2){width:auto}
    #saTable th:nth-child(3),#saTable td:nth-child(3){width:45px}
    #saTable th:nth-child(4),#saTable td:nth-child(4){width:49px}
    #saTable th:nth-child(5),#saTable td:nth-child(5){width:25px;text-align:right}
    .controls{display:flex;gap:8px;align-items:center}
    .preview{flex:1;border:1px solid #e6e9f2;border-radius:8px;padding:8px;background:#fff;overflow:auto;display:flex;flex-direction:column;min-height:0}
    .svg-container{width:100%;flex:1;display:flex;justify-content:center;align-items:flex-start;min-height:0}
    .small{font-size:12px}
    .note{background:#fff8e6;padding:8px;border-radius:6px;font-size:13px}
    footer{padding:8px;border-top:1px solid #eceef6;margin-top:auto}
    .row{display:flex;gap:8px;flex:1;min-height:0}
    .half{flex:1}
    input[type=file]{padding:6px}
    /* Karten-Layout für Wechselrichter */
    .cards-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px;margin-top:8px}
    .card{background:#fff;border:1px solid #e6e9f2;border-radius:8px;padding:12px;font-size:13px;position:relative}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}
    .card-content{display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;margin-bottom:8px}
    .card-field{display:flex;flex-direction:column}
    .card-field-label{color:var(--muted);font-size:11px;margin-bottom:2px}
    .card-field-value{font-weight:500}
    .card-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px;padding-top:8px;border-top:1px solid #f0f2fa}
    .card-full-width{grid-column:1/-1}

    /* Kollapsible Sektionen */
    .section-header{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px 8px 0 0;padding:12px;margin:12px 0 0 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s ease;font-weight:600;color:#334155;position:relative;z-index:1}
    .section-header:hover{background:#f1f5f9;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .section-header.collapsed{margin-bottom:12px;border-radius:8px;border-bottom:1px solid #e2e8f0}
    .section-content{overflow:visible;transition:max-height 0.3s ease;max-height:none;background:#fafbfc;border:1px solid #e2e8f0;border-top:none;border-radius:0 0 8px 8px;padding:16px;margin:0 0 12px 0;box-shadow:inset 0 1px 3px rgba(0,0,0,0.02)}
    .section-content:not(.collapsed){max-height:none}
    .section-content.collapsed{overflow:hidden;max-height:0}
    .section-content.collapsed{max-height:0;padding:0;margin:0;border:none;box-shadow:none}
    .chevron{transition:transform 0.2s ease;font-size:14px;color:#64748b;user-select:none;pointer-events:none}
    .chevron.collapsed{transform:rotate(-90deg)}
    .section-title{font-size:16px;margin:0}
    .section-content label{margin-top:12px}
    .section-content label:first-child{margin-top:0}
    .section-content > div{margin-top:0}
    .section-content .list{background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:8px;margin-top:12px}
    .section-content button{margin-top:0}
    hr{display:none}
  </style>
  <script src="spd.js"></script>
</head>
<body>
  <div class="sidebar">
    <div class="section-header" onclick="toggleSection('projekt')">
      <h2 class="section-title">Projekt</h2>
      <span class="chevron">▼</span>
    </div>
    <div class="section-content" id="projekt-content">
      <label>Projektname
        <input id="projectName" placeholder="Mein PV-Projekt" />
      </label>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="newProject" style="flex: 1">Neu</button>
        <button id="saveProject" style="flex: 1">Projekt speichern</button>
        <button id="openProject" style="flex: 1">Projekt öffnen</button>
        <input id="loadFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <hr />
    <div class="section-header collapsed" onclick="toggleSection('pv-module')">
      <h2 class="section-title">PV-Module Konfiguration</h2>
      <span class="chevron collapsed">▼</span>
    </div>
    <div class="section-content collapsed" id="pv-module-content">
      <div>
        <label>Hersteller + Typ
          <input id="moduleInfo" placeholder="z.B. SunPower Maxeon 3" />
        </label>
        <label>Modul Nennleistung (W)
          <input id="moduleWattage" type="number" min="1" value="420" />
        </label>
      </div>
    </div>

    <hr />
    <div class="section-header collapsed" onclick="toggleSection('solarflaechen')">
      <h2 class="section-title">Solarflächen</h2>
      <span class="chevron collapsed">▼</span>
    </div>
    <div class="section-content collapsed" id="solarflaechen-content">
      <div>
        <label>Name
          <input id="saName" placeholder="Dach Süd" />
        </label>
        <label>Anzahl Module
          <input id="saCount" type="number" min="1" value="10" />
        </label>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
          <button id="addSA">➕ Solarfläche hinzufügen</button>
        </div>
      </div>
      <div class="list">
        <table id="saTable"><thead><tr><th>ID</th><th>Name</th><th>Module</th><th>Leistung</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <hr />
    <div class="section-header collapsed" onclick="toggleSection('wechselrichter')">
      <h2 class="section-title">Wechselrichter</h2>
      <span class="chevron collapsed">▼</span>
    </div>
    <div class="section-content collapsed" id="wechselrichter-content">
      <label>Name
        <input id="invName" placeholder="SMA Sunny Tripower" />
      </label>
      <label>Phasen
        <select id="invPhases"><option value="3-ph">3-ph</option><option value="1-ph">1-ph</option></select>
      </label>
      <label>AC-Nennleistung (W)
        <input id="invAcW" type="number" min="1" value="5000" />
      </label>
      <label>LS-Nennstrom (A)
        <input id="invLsAmps" type="number" min="6" max="125" value="25" />
        <div class="muted small" style="margin-top:2px;">Vorschlag wird automatisch berechnet (10m Leitungslänge)</div>
      </label>
      <label>Leitungsquerschnitt (mm²)
        <input id="invCableSize" type="number" min="1.5" max="50" step="0.5" value="4" />
        <div class="muted small" style="margin-top:2px;">Vorschlag wird automatisch berechnet (10m Leitungslänge)</div>
      </label>
      <label style="display:flex;align-items:center;margin-top:12px;">
        <input id="invEmergencyPower" type="checkbox" style="width:auto;margin-right:8px;margin-top:0;" />
        Notstrom-Funktionalität
      </label>
      <label>Solarflächen zuordnen (STRG/SHIFT für mehrere)
        <select id="invAssign" multiple style="height:120px"></select>
      </label>
      <div style="margin-top:8px;display:flex;flex-direction:row;gap:6px">
        <button id="addInv" style="flex: 1">➕ Wechselrichter hinzufügen</button>
        <button id="cancelEditInv" style="display:none; flex: 1">❌ Abbrechen</button>
      </div>
      <div class="list">
        <div id="invContainer" class="cards-container"></div>
      </div>
    </div>
    <hr />
    <div class="section-header collapsed" onclick="toggleSection('batterie')">
      <h2 class="section-title">Batterie</h2>
      <span class="chevron collapsed">▼</span>
    </div>
    <div class="section-content collapsed" id="batterie-content">
      <label>Name
        <input id="batName" placeholder="BatteryX" />
      </label>
      <label>Kapazität (kWh)
        <input id="batKwh" type="number" min="0.1" step="0.1" value="10" />
      </label>
      <label>Max. Leistung (kW)
        <input id="batPowerKw" type="number" min="0" step="0.1" value="5" />
      </label>
      <label>Zugeordneter Wechselrichter
        <select id="batAssign"><option value="">-- keiner --</option></select>
      </label>
      <div style="margin-top:8px;display:flex;flex-direction:row;gap:6px">
        <button id="addBat" style="flex: 1">🔄 Batterie aktualisieren</button>
        <button id="removeBat" class="danger" style="flex: 1">✕ Batterie löschen</button>
      </div>
    </div>

  </div>

  <div class="main">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="metaBox" class="small muted" style="margin-top:4px;">Keine Metadaten</div>
      </div>
      <div class="controls">
        <button id="gen">Schaltplan generieren</button>
        <button id="exportPdf">Export PDF</button>
      </div>
    </header>

    <div class="row">
      <div class="preview">
        <h3>Vorschau</h3>
        <div class="svg-container" id="svgWrap">Keine Vorschau. Bitte „Schaltplan generieren“ klicken.</div>
      </div>

    </div>
  </div>

  <!-- libs via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/svg2pdf.js@2.2.1/dist/svg2pdf.umd.min.js"></script>

  <script>
    // Toggle section visibility
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId + '-content');
      const chevron = event.target.closest('.section-header').querySelector('.chevron');
      const header = event.target.closest('.section-header');

      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.classList.remove('collapsed');
        header.classList.remove('collapsed');
      } else {
        content.classList.add('collapsed');
        chevron.classList.add('collapsed');
        header.classList.add('collapsed');
      }
    }

    // Collapse all sections except the first one (Projekt)
    function collapseAllExceptFirst() {
      const sections = ['pv-module', 'solarflaechen', 'wechselrichter', 'batterie'];
      sections.forEach(sectionId => {
        const content = document.getElementById(sectionId + '-content');
        const header = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
        const chevron = header ? header.querySelector('.chevron') : null;

        if (content && header && chevron) {
          content.classList.add('collapsed');
          chevron.classList.add('collapsed');
          header.classList.add('collapsed');
        }
      });
    }
    // Simple client-side app
    (function(){
      // state
      const state = {
        projectName: 'Mein PV-Projekt',
        moduleConfig: {
          info: '', // Hersteller + Typ
          wattage: 420 // Nennleistung in W
        },
        solarAreas: [],
        inverters: [],
        battery: null,
        meter: { id: 'Z1', name: 'Zweirichtungszähler' }
      };

      // helpers
      const $ = id => document.getElementById(id);

      // ID generator with dynamic starting point
      let uidCounter = 1;
      const uid = () => (uidCounter++).toString(36);

      // Function to update UID counter based on existing IDs
      function updateUidCounter() {
        let maxId = 0;

        // Check solar areas
        state.solarAreas.forEach(sa => {
          const match = sa.id.match(/^SA(.+)$/);
          if (match) {
            const idNum = parseInt(match[1], 36);
            if (!isNaN(idNum) && idNum >= maxId) {
              maxId = idNum + 1;
            }
          }
        });

        // Check inverters
        state.inverters.forEach(inv => {
          const match = inv.id.match(/^INV(.+)$/);
          if (match) {
            const idNum = parseInt(match[1], 36);
            if (!isNaN(idNum) && idNum >= maxId) {
              maxId = idNum + 1;
            }
          }
        });

        uidCounter = Math.max(uidCounter, maxId);
      }

      // DOM elems
      const saTable = $('saTable').querySelector('tbody');
      const invContainer = $('invContainer');
      const invAssign = $('invAssign');
      const batAssign = $('batAssign');

      // Circuit breaker calculation function (shared between UI and SVG generation)
      function calculateNormalCurrent(acPowerW, phases) {
        const acPowerKW = acPowerW / 1000;
        let current;

        if (phases === '1-ph') {
          // 1-phase: I = P / (U * cos φ), U = 230V, cos φ ≈ 1
          current = acPowerKW / 0.23;
        } else {
          // 3-phase: I = P / (√3 * U * cos φ), U = 400V, cos φ ≈ 1
          current = acPowerKW / (Math.sqrt(3) * 0.4);
        }

        // Round up to next standard circuit breaker size
        const standardSizes = [6, 10, 13, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125];
        for (let size of standardSizes) {
          if (current <= size * 0.8) { // 80% rule for continuous load
            return size;
          }
        }
        return 125; // fallback for very high power
      }

      function calculateCableSize(acPowerW, phases, cableLengthMeters = 10) {
        const acPowerKW = acPowerW / 1000;
        let current;

        if (phases === '1-ph') {
          current = acPowerKW / 0.23;
          var voltage = 230;
        } else {
          current = acPowerKW / (Math.sqrt(3) * 0.4);
          var voltage = 400;
        }

        const rho = 0.0175; // spezifischer Widerstand Kupfer in Ω·mm²/m
        const totalLength = cableLengthMeters * 2; // Hin- und Rückleitung

        const cableSizes = [
          { size: 1.5, capacity: 18.5 },
          { size: 2.5, capacity: 25 },
          { size: 4, capacity: 32 },
          { size: 6, capacity: 41 },
          { size: 10, capacity: 57 },
          { size: 16, capacity: 76 },
          { size: 25, capacity: 101 },
          { size: 35, capacity: 125 },
          { size: 50, capacity: 151 }
        ];

        for (let cable of cableSizes) {
          const voltageDrop = (2 * totalLength * current * rho) / cable.size;
          const maxDrop = voltage * 0.03; // max. 3% Spannungsabfall

          if (current <= cable.capacity * 0.8 && voltageDrop <= maxDrop) {
            return cable.size;
          }
        }

        return 50; // fallback
      }

      // Cable cross-section calculation based on LS current rating and voltage drop
      function calculateCableSizeFromLsCurrent(lsAmps, cableLengthMeters = 10, voltage = 230) {
        const rho = 0.0175; // spezifischer Widerstand von Kupfer in Ω·mm²/m
        const totalLength = cableLengthMeters * 2; // Hin- und Rückleitung
        const maxVoltageDrop = voltage * 0.03; // maximal erlaubter Spannungsfall (z. B. 3%)

        const cableSizes = [
          { size: 1.5, capacity: 18.5 },
          { size: 2.5, capacity: 25 },
          { size: 4, capacity: 32 },
          { size: 6, capacity: 41 },
          { size: 10, capacity: 57 },
          { size: 16, capacity: 76 },
          { size: 25, capacity: 101 },
          { size: 35, capacity: 125 },
          { size: 50, capacity: 151 }
        ];

        for (let cable of cableSizes) {
          const voltageDrop = (totalLength * lsAmps * rho) / cable.size;

          if (lsAmps <= cable.capacity && voltageDrop <= maxVoltageDrop) {
            return cable.size;
          }
        }

        return 50; // fallback für sehr hohe Ströme oder lange Leitung
      }


      function renderLists(){
        // solarareas
        saTable.innerHTML=''; invAssign.innerHTML='';
        state.solarAreas.forEach(sa=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${sa.id}</td><td>${sa.name}</td><td>${sa.modules}</td><td>${(sa.modules*state.moduleConfig.wattage)/1000} kW</td><td><button class="danger btn-small" data-id="${sa.id}" title="Löschen">✕</button></td>`;
          saTable.appendChild(tr);
          invAssign.appendChild(new Option(`${sa.name} (${sa.id})`, sa.id));
        });
        // invs
        invContainer.innerHTML=''; batAssign.innerHTML=''; batAssign.appendChild(new Option('-- keiner --',''));
        state.inverters.forEach(inv=>{
          const card = document.createElement('div');
          card.className = 'card';
          const emergencyText = inv.emergencyPower ? 'Ja' : 'Nein';
          const emergencyIcon = inv.emergencyPower ? '⚡' : '';
          const assignedAreas = inv.assignedSolarAreaIds.length > 0 ? inv.assignedSolarAreaIds.join(', ') : 'Keine';
          card.innerHTML = `
            <div class="card-header">
              <span><strong>${inv.name}</strong> (${inv.id})</span>
              <span>${emergencyIcon}</span>
            </div>
            <div class="card-content">
              <div class="card-field">
                <div class="card-field-label">Phasen</div>
                <div class="card-field-value">${inv.phases}</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">AC-Leistung</div>
                <div class="card-field-value">${(inv.ac_power_w/1000).toFixed(2)} kW</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">LS-Schutz</div>
                <div class="card-field-value">${inv.ls_amps || 'N/A'} A</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Kabelquerschnitt</div>
                <div class="card-field-value">${inv.cable_size || 'N/A'} mm²</div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Notstrom</div>
                <div class="card-field-value">${emergencyText}</div>
              </div>
              <div class="card-field card-full-width">
                <div class="card-field-label">Zugeordnete Flächen</div>
                <div class="card-field-value">${assignedAreas}</div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn-small" style="flex: 1" data-edit-id="${inv.id}" title="Bearbeiten">✏️ Bearbeiten</button>
              <button class="danger btn-small" style="flex: 1" data-delete-id="${inv.id}" title="Löschen">✕ Löschen</button>
            </div>
          `;
          invContainer.appendChild(card);
          batAssign.appendChild(new Option(`${inv.name} (${inv.id})`, inv.id));
        });

        // Event-Handler für Bearbeiten und Löschen hinzufügen
        invContainer.querySelectorAll('button[data-edit-id]').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-edit-id');
          const inv = state.inverters.find(i => i.id === id);
          if(inv) {
            // Formular mit Werten füllen
            $('invName').value = inv.name;
            $('invPhases').value = inv.phases;
            $('invAcW').value = inv.ac_power_w;
            $('invLsAmps').value = inv.ls_amps;
            $('invCableSize').value = inv.cable_size;
            $('invEmergencyPower').checked = inv.emergencyPower;
            // Zugewiesene Solarflächen auswählen
            Array.from($('invAssign').options).forEach(option => {
              option.selected = inv.assignedSolarAreaIds.includes(option.value);
            });
            // Button-Text ändern und ID merken
            $('addInv').textContent = '🔄 Wechselrichter aktualisieren';
            $('addInv').setAttribute('data-editing-id', id);
            $('cancelEditInv').style.display = 'inline-block';
          }
        }));

        invContainer.querySelectorAll('button[data-delete-id]').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-delete-id');
          if(confirm('Wechselrichter löschen?')) {
            state.inverters = state.inverters.filter(i => i.id !== id);
            renderLists();
            resetInverterForm();
          }
        }));

        // battery
        if(state.battery){
          $('batName').value = state.battery.name;
          $('batKwh').value = state.battery.kwh;
          $('batPowerKw').value = state.battery.power_kw ?? '';
          $('batAssign').value = state.battery.assignedInvId || '';
        }

        // attach delete handlers
        saTable.querySelectorAll('button').forEach(btn=>btn.addEventListener('click', e=>{
          const id = btn.getAttribute('data-id'); state.solarAreas = state.solarAreas.filter(s=>s.id!==id);
          // remove references in inverters
          state.inverters.forEach(inv=>{ inv.assignedSolarAreaIds = inv.assignedSolarAreaIds.filter(x=>x!==id); });
          renderLists();
        }));

        updateMetaBox();
      }

      function updateMetaBox(){
        const hasEmergencyPower = state.inverters.some(inv => inv.emergencyPower);
        $('metaBox').innerHTML = `<strong>${state.projectName}</strong><br>PV-Flächen: ${state.solarAreas.length} | Wechselrichter: ${state.inverters.length} | Batterie: ${state.battery? 'ja':'nein'} | Notstrom: ${hasEmergencyPower ? 'ja' : 'nein'}`;
      }

      // add solar area
      $('addSA').addEventListener('click', ()=>{
        const name = $('saName').value.trim();
        const modules = parseInt($('saCount').value,10);
        if(!name){return alert('Name ist Pflicht');}
        if(!modules || modules<1) return alert('Anzahl Module muss >=1 sein');
        if(!state.moduleConfig.wattage || state.moduleConfig.wattage<=0) return alert('Modul Nennleistung muss in der PV-Module Konfiguration eingetragen werden');
        const id = 'SA'+uid();
        state.solarAreas.push({id,name,modules});
        $('saName').value=''; $('saCount').value=10;
        renderLists();
      });

      // add/edit inverter
      $('addInv').addEventListener('click', ()=>{
        const editingId = $('addInv').getAttribute('data-editing-id');
        const name = $('invName').value.trim()||'WR';
        const phases = $('invPhases').value;
        const ac_power_w = parseFloat($('invAcW').value)||0;
        const ls_amps = parseInt($('invLsAmps').value)||25;
        const cable_size = parseFloat($('invCableSize').value)||4;
        const emergencyPower = $('invEmergencyPower').checked || false;
        const assigned = Array.from($('invAssign').selectedOptions).map(o=>o.value);
        if(editingId) {
          // Bearbeiten-Modus: vorhandenen Wechselrichter aktualisieren
          const inv = state.inverters.find(i => i.id === editingId);
          if(inv) {
            inv.name = name;
            inv.phases = phases;
            inv.ac_power_w = ac_power_w;
            inv.ls_amps = ls_amps;
            inv.cable_size = cable_size;
            inv.emergencyPower = emergencyPower;
            inv.assignedSolarAreaIds = assigned;
          }
          resetInverterForm();
        } else {
          // Normaler Hinzufügen-Modus
          const id = 'INV'+uid();
          state.inverters.push({id,name,phases,ac_power_w,ls_amps,cable_size,emergencyPower,assignedSolarAreaIds:assigned,assignedBatteryId:null});
          resetInverterForm();
        }
        renderLists();
      });

      // cancel edit inverter
      $('cancelEditInv').addEventListener('click', ()=>{
        resetInverterForm();
      });

      // Hilfsfunktion zum Zurücksetzen des Wechselrichter-Formulars
      function resetInverterForm() {
        $('invName').value='';
        $('invAcW').value=5000;
        $('invLsAmps').value=25;
        $('invCableSize').value=4;
        $('invEmergencyPower').checked=false;
        $('invAssign').selectedIndex=-1;
        $('addInv').textContent = '➕ Wechselrichter hinzufügen';
        $('addInv').removeAttribute('data-editing-id');
        $('cancelEditInv').style.display = 'none';
      }

      // battery
      $('addBat').addEventListener('click', ()=>{
        const name = $('batName').value.trim()||'BAT';
        const kwh = parseFloat($('batKwh').value)||0;
        const power_kw = parseFloat($('batPowerKw').value)||0;
        const assignedInvId = $('batAssign').value||null;
        if(!state.battery) state.battery = { id:'BAT1', name, kwh, power_kw, assignedInvId };
        else { state.battery.name = name; state.battery.kwh = kwh; state.battery.power_kw = power_kw; state.battery.assignedInvId = assignedInvId; }
        renderLists();
      });
      $('removeBat').addEventListener('click', ()=>{ state.battery=null; renderLists(); });

      // project controls
      $('newProject').addEventListener('click', ()=>{
        if(!confirm('Neues Projekt erstellen? Alle nicht gespeicherten Änderungen gehen verloren.')) return;
        collapseAllExceptFirst();
        state.projectName = 'Mein PV-Projekt';
        state.moduleConfig = { info: '', wattage: 420 };
        state.solarAreas=[]; state.inverters=[]; state.battery=null;
        uidCounter = 1; // Reset counter for new project
        renderLists();
        $('projectName').value='';
        $('moduleInfo').value='';
        $('moduleWattage').value=420;
        $('svgWrap').innerHTML='Keine Vorschau. Bitte „Schaltplan generieren“ klicken.';

      });

      $('projectName').addEventListener('input',(e)=>{ state.projectName = e.target.value; updateMetaBox(); });

      // module config listeners
      $('moduleInfo').addEventListener('input',(e)=>{ state.moduleConfig.info = e.target.value; renderLists(); });

      // Auto-calculate LS suggestion when AC power or phases change
      function updateLsSuggestion() {
        const acPowerW = parseFloat($('invAcW').value) || 0;
        const phases = $('invPhases').value;
        if (acPowerW > 0) {
          const lsSuggestion = calculateNormalCurrent(acPowerW, phases);
          $('invLsAmps').value = lsSuggestion;
          $('invLsAmps').style.backgroundColor = '#e8f5e8'; // Light green to indicate auto-calculated

          setTimeout(() => {
            $('invLsAmps').style.backgroundColor = '';
          }, 500);

          // Trigger cable suggestion update based on new LS value
          updateCableSuggestion();
        }
      }

      // Auto-calculate cable suggestion when LS current changes
      function updateCableSuggestion() {
        const lsAmps = parseInt($('invLsAmps').value) || 0;
        if (lsAmps > 0) {
          const cableSuggestion = calculateCableSizeFromLsCurrent(lsAmps);
          $('invCableSize').value = cableSuggestion;
          $('invCableSize').style.backgroundColor = '#e8f5e8'; // Light green to indicate auto-calculated

          setTimeout(() => {
            $('invCableSize').style.backgroundColor = '';
          }, 500);
        }
      }

      $('invAcW').addEventListener('input', updateLsSuggestion);
      $('invPhases').addEventListener('change', updateLsSuggestion);
      $('invLsAmps').addEventListener('input', updateCableSuggestion);
      $('moduleWattage').addEventListener('input',(e)=>{
        state.moduleConfig.wattage = parseFloat(e.target.value) || 420;
        renderLists();
      });

      // save/load
      $('saveProject').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify({projectName:state.projectName,moduleConfig:state.moduleConfig,solarAreas:state.solarAreas,inverters:state.inverters,battery:state.battery},null,2)],{type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (state.projectName||'pv-project') + '.pvproj.json'; a.click();
      });

      $('openProject').addEventListener('click', ()=>{
        $('loadFile').click();
      });

      $('loadFile').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return; const txt = await f.text();
        try{
          const obj = JSON.parse(txt);
          state.projectName = obj.projectName||state.projectName;
          state.moduleConfig = obj.moduleConfig||{ info: '', wattage: 420 };
          state.solarAreas = obj.solarAreas||[];
          state.inverters = obj.inverters||[];
          state.battery = obj.battery||null;
          collapseAllExceptFirst();
          $('projectName').value = state.projectName;
          $('moduleInfo').value = state.moduleConfig.info;
          $('moduleWattage').value = state.moduleConfig.wattage;
          updateUidCounter(); // Update counter based on loaded IDs
          renderLists();
        }catch(err){ alert('Fehler beim Laden: '+err.message); }
      });

      // Professional electrical schematic generation
      function buildProfessionalSVG(){
        const width = 1000;
        const height = 700;
        const xmlns = 'http://www.w3.org/2000/svg';

        // Lookup table for circuit breaker nominal current based on AC power
        function calculateNominalCurrent(acPowerW, phases) {
          const acPowerKW = acPowerW / 1000;
          let current;

          if (phases === '1-ph') {
            // 1-phase: I = P / (U * cos φ), U = 230V, cos φ ≈ 1
            current = acPowerKW / 0.23;
          } else {
            // 3-phase: I = P / (√3 * U * cos φ), U = 400V, cos φ ≈ 1
            current = acPowerKW / (Math.sqrt(3) * 0.4);
          }

          // Round up to next standard circuit breaker size
          const standardSizes = [6, 10, 13, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125];
          for (let size of standardSizes) {
            if (current <= size * 0.8) { // 80% rule for continuous load
              return size;
            }
          }
          return 125; // fallback for very high power
        }

        // Create main SVG container
        const svg = document.createElementNS(xmlns, 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        // Für bessere <use>-Kompatibilität
        svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
        svg.setAttribute('style', 'background: white; border: 1px solid #000;');

        // Define symbols and patterns
        const defs = document.createElementNS(xmlns, 'defs');

        // PV Module Symbol
        const pvSymbol = document.createElementNS(xmlns, 'g');
        pvSymbol.setAttribute('id', 'pv-module');
        const pvRect = document.createElementNS(xmlns, 'rect');
        pvRect.setAttribute('x', '-25');
        pvRect.setAttribute('y', '-15');
        pvRect.setAttribute('width', '50');
        pvRect.setAttribute('height', '30');
        pvRect.setAttribute('fill', 'none');
        pvRect.setAttribute('stroke', '#000');
        pvRect.setAttribute('stroke-width', '2');

        // Solar cell grid pattern
        for(let i = 0; i < 3; i++) {
          for(let j = 0; j < 2; j++) {
            const cell = document.createElementNS(xmlns, 'rect');
            cell.setAttribute('x', -20 + i * 13);
            cell.setAttribute('y', -10 + j * 10);
            cell.setAttribute('width', '10');
            cell.setAttribute('height', '8');
            cell.setAttribute('fill', 'none');
            cell.setAttribute('stroke', '#000');
            cell.setAttribute('stroke-width', '0.5');
            pvSymbol.appendChild(cell);
          }
        }

        pvSymbol.appendChild(pvRect);
        defs.appendChild(pvSymbol);

        // Inverter Symbol (Wechselrichter)
        const invSymbol = document.createElementNS(xmlns, 'g');
        invSymbol.setAttribute('id', 'inverter');
        const invRect = document.createElementNS(xmlns, 'rect');
        invRect.setAttribute('x', '-30');
        invRect.setAttribute('y', '-25');
        invRect.setAttribute('width', '60');
        invRect.setAttribute('height', '50');
        invRect.setAttribute('fill', 'none');
        invRect.setAttribute('stroke', '#000');
        invRect.setAttribute('stroke-width', '2');

        // DC input symbol (=)
        const dcLine1 = document.createElementNS(xmlns, 'line');
        dcLine1.setAttribute('x1', '-20');
        dcLine1.setAttribute('y1', '-5');
        dcLine1.setAttribute('x2', '-10');
        dcLine1.setAttribute('y2', '-5');
        dcLine1.setAttribute('stroke', '#000');
        dcLine1.setAttribute('stroke-width', '2');

        const dcLine2 = document.createElementNS(xmlns, 'line');
        dcLine2.setAttribute('x1', '-20');
        dcLine2.setAttribute('y1', '5');
        dcLine2.setAttribute('x2', '-10');
        dcLine2.setAttribute('y2', '5');
        dcLine2.setAttribute('stroke', '#000');
        dcLine2.setAttribute('stroke-width', '2');

        // AC output symbol (~)
        const acPath = document.createElementNS(xmlns, 'path');
        acPath.setAttribute('d', 'M 10 -5 Q 15 -10 20 -5 Q 25 0 30 -5');
        acPath.setAttribute('fill', 'none');
        acPath.setAttribute('stroke', '#000');
        acPath.setAttribute('stroke-width', '2');

        invSymbol.appendChild(invRect);
        invSymbol.appendChild(dcLine1);
        invSymbol.appendChild(dcLine2);
        invSymbol.appendChild(acPath);
        defs.appendChild(invSymbol);

        // Battery Symbol
        const batSymbol = document.createElementNS(xmlns, 'g');
        batSymbol.setAttribute('id', 'battery');

        // Battery cells
        const longLine1 = document.createElementNS(xmlns, 'line');
        longLine1.setAttribute('x1', '-15');
        longLine1.setAttribute('y1', '-20');
        longLine1.setAttribute('x2', '-15');
        longLine1.setAttribute('y2', '20');
        longLine1.setAttribute('stroke', '#000');
        longLine1.setAttribute('stroke-width', '3');

        const shortLine1 = document.createElementNS(xmlns, 'line');
        shortLine1.setAttribute('x1', '-10');
        shortLine1.setAttribute('y1', '-15');
        shortLine1.setAttribute('x2', '-10');
        shortLine1.setAttribute('y2', '15');
        shortLine1.setAttribute('stroke', '#000');
        shortLine1.setAttribute('stroke-width', '2');

        const longLine2 = document.createElementNS(xmlns, 'line');
        longLine2.setAttribute('x1', '-5');
        longLine2.setAttribute('y1', '-20');
        longLine2.setAttribute('x2', '-5');
        longLine2.setAttribute('y2', '20');
        longLine2.setAttribute('stroke', '#000');
        longLine2.setAttribute('stroke-width', '3');

        const shortLine2 = document.createElementNS(xmlns, 'line');
        shortLine2.setAttribute('x1', '0');
        shortLine2.setAttribute('y1', '-15');
        shortLine2.setAttribute('x2', '0');
        shortLine2.setAttribute('y2', '15');
        shortLine2.setAttribute('stroke', '#000');
        shortLine2.setAttribute('stroke-width', '2');

        batSymbol.appendChild(longLine1);
        batSymbol.appendChild(shortLine1);
        batSymbol.appendChild(longLine2);
        batSymbol.appendChild(shortLine2);
        defs.appendChild(batSymbol);

        // Meter Symbol (Zweirichtungszähler)
        const meterSymbol = document.createElementNS(xmlns, 'g');
        meterSymbol.setAttribute('id', 'meter');
        const meterRect = document.createElementNS(xmlns, 'rect');
        meterRect.setAttribute('x', '-27');
        meterRect.setAttribute('y', '-25');
        meterRect.setAttribute('width', '50');
        meterRect.setAttribute('height', '50');
        meterRect.setAttribute('fill', 'none');
        meterRect.setAttribute('stroke', '#000');
        meterRect.setAttribute('stroke-width', '2');

        // kWh text
        const kwhText = document.createElementNS(xmlns, 'text');
        kwhText.setAttribute('x', '0');
        kwhText.setAttribute('y', '5');
        kwhText.setAttribute('text-anchor', 'middle');
        kwhText.setAttribute('font-family', 'Arial');
        kwhText.setAttribute('font-size', '10');
        kwhText.textContent = 'Z1';

        const bidirectionalArrow = document.createElementNS(xmlns, 'path');
        bidirectionalArrow.setAttribute('d', 'M -12 -15 L -15 -12 L -12 -9 M -15 -12 L 15 -12 M 12 -15 L 15 -12 L 12 -9');
        bidirectionalArrow.setAttribute('fill', 'none');
        bidirectionalArrow.setAttribute('stroke', '#000');
        bidirectionalArrow.setAttribute('stroke-width', '1.5');

        meterSymbol.appendChild(meterRect);
        meterSymbol.appendChild(kwhText);
        meterSymbol.appendChild(bidirectionalArrow);
        defs.appendChild(meterSymbol);

        // Leitungsschutzschalter (LS) Symbol
        const lsSymbol = document.createElementNS(xmlns, 'g');
        lsSymbol.setAttribute('id', 'circuit-breaker');

        // Main body (rectangle)
        const lsRect = document.createElementNS(xmlns, 'rect');
        lsRect.setAttribute('x', '-8');
        lsRect.setAttribute('y', '-6');
        lsRect.setAttribute('width', '16');
        lsRect.setAttribute('height', '12');
        lsRect.setAttribute('fill', 'none');
        lsRect.setAttribute('stroke', '#000');
        lsRect.setAttribute('stroke-width', '2');

        // Circuit breaker symbol (curved line inside)
        const lsCurve = document.createElementNS(xmlns, 'path');
        lsCurve.setAttribute('d', 'M -5 -2 Q 0 -4 5 -2 Q 0 0 -5 2');
        lsCurve.setAttribute('fill', 'none');
        lsCurve.setAttribute('stroke', '#000');
        lsCurve.setAttribute('stroke-width', '1.5');

        // Connection points
        const lsLine1 = document.createElementNS(xmlns, 'line');
        lsLine1.setAttribute('x1', '0');
        lsLine1.setAttribute('y1', '-6');
        lsLine1.setAttribute('x2', '0');
        lsLine1.setAttribute('y2', '-10');
        lsLine1.setAttribute('stroke', '#000');
        lsLine1.setAttribute('stroke-width', '2');

        const lsLine2 = document.createElementNS(xmlns, 'line');
        lsLine2.setAttribute('x1', '0');
        lsLine2.setAttribute('y1', '6');
        lsLine2.setAttribute('x2', '0');
        lsLine2.setAttribute('y2', '10');
        lsLine2.setAttribute('stroke', '#000');
        lsLine2.setAttribute('stroke-width', '2');

        lsSymbol.appendChild(lsRect);
        lsSymbol.appendChild(lsCurve);
        lsSymbol.appendChild(lsLine1);
        lsSymbol.appendChild(lsLine2);
        defs.appendChild(lsSymbol);

        // SLS (Selektiver Leitungsschutzschalter) Symbol
        const slsSymbol = document.createElementNS(xmlns, 'g');
        slsSymbol.setAttribute('id', 'selective-circuit-breaker');

        // Main body (rectangle)
        const slsRect = document.createElementNS(xmlns, 'rect');
        slsRect.setAttribute('x', '-12');
        slsRect.setAttribute('y', '-8');
        slsRect.setAttribute('width', '24');
        slsRect.setAttribute('height', '16');
        slsRect.setAttribute('fill', 'none');
        slsRect.setAttribute('stroke', '#000');
        slsRect.setAttribute('stroke-width', '2');

        // SLS symbol (curved line with S-shape inside)
        const slsCurve = document.createElementNS(xmlns, 'path');
        slsCurve.setAttribute('d', 'M -8 -4 Q -4 -6 0 -4 Q 4 -2 8 -4 M -8 4 Q -4 2 0 4 Q 4 6 8 4');
        slsCurve.setAttribute('fill', 'none');
        slsCurve.setAttribute('stroke', '#000');
        slsCurve.setAttribute('stroke-width', '1.5');

        // Connection points
        const slsLine1 = document.createElementNS(xmlns, 'line');
        slsLine1.setAttribute('x1', '0');
        slsLine1.setAttribute('y1', '-8');
        slsLine1.setAttribute('x2', '0');
        slsLine1.setAttribute('y2', '-12');
        slsLine1.setAttribute('stroke', '#000');
        slsLine1.setAttribute('stroke-width', '2');

        const slsLine2 = document.createElementNS(xmlns, 'line');
        slsLine2.setAttribute('x1', '0');
        slsLine2.setAttribute('y1', '8');
        slsLine2.setAttribute('x2', '0');
        slsLine2.setAttribute('y2', '12');
        slsLine2.setAttribute('stroke', '#000');
        slsLine2.setAttribute('stroke-width', '2');

        slsSymbol.appendChild(slsRect);
        slsSymbol.appendChild(slsCurve);
        slsSymbol.appendChild(slsLine1);
        slsSymbol.appendChild(slsLine2);
        defs.appendChild(slsSymbol);



        svg.appendChild(defs);

        // Layout positions - new vertical layout
        const pvX = 100; // PV modules on the left
        const invX = 300; // Inverters to the right of PV modules
        const startY = 150; // Starting Y position
        const verticalSpacing = 80; // Vertical spacing between components
        const meterX = 660; // Zweirichtungszähler position
        const spdKombiX = 740; // SPD Kombi after meter
        const slsX = 810; // SLS position
        const hakX = 860; // HAK position (Ende der Schaltung)
        const batY = 500;


        const titleText = document.createElementNS(xmlns, 'text');
        titleText.setAttribute('x', '500');
        titleText.setAttribute('y', '40');
        titleText.setAttribute('text-anchor', 'middle');
        titleText.setAttribute('font-family', 'Arial');
        titleText.setAttribute('font-size', '14');
        titleText.setAttribute('font-weight', 'bold');
        titleText.textContent = state.projectName || 'PV-Anlage Schaltplan';
        svg.appendChild(titleText);

        // Data box in upper right corner
        const dataBoxX = width - 200;
        const dataBoxY = 20;
        const dataBoxWidth = 180;
        const dataBoxHeight = 120;

        // Data box background
        const dataBoxBg = document.createElementNS(xmlns, 'rect');
        dataBoxBg.setAttribute('x', dataBoxX);
        dataBoxBg.setAttribute('y', dataBoxY);
        dataBoxBg.setAttribute('width', dataBoxWidth);
        dataBoxBg.setAttribute('height', dataBoxHeight);
        dataBoxBg.setAttribute('fill', '#f8f9fa');
        dataBoxBg.setAttribute('stroke', '#000');
        dataBoxBg.setAttribute('stroke-width', '1');
        dataBoxBg.setAttribute('rx', '5');
        svg.appendChild(dataBoxBg);

        // Calculate totals for data box
        const totalPvPower = state.solarAreas.reduce((sum, sa) => sum + (sa.modules * state.moduleConfig.wattage), 0);
        const totalInvPower = state.inverters.reduce((sum, inv) => sum + inv.ac_power_w, 0);

        // Data box title
        const dataBoxTitle = document.createElementNS(xmlns, 'text');
        dataBoxTitle.setAttribute('x', dataBoxX + 10);
        dataBoxTitle.setAttribute('y', dataBoxY + 18);
        dataBoxTitle.setAttribute('font-family', 'Arial');
        dataBoxTitle.setAttribute('font-size', '11');
        dataBoxTitle.setAttribute('font-weight', 'bold');
        dataBoxTitle.textContent = 'Anlagedaten:';
        svg.appendChild(dataBoxTitle);

        // PV-Generator gesamt
        const pvTotalLabel = document.createElementNS(xmlns, 'text');
        pvTotalLabel.setAttribute('x', dataBoxX + 10);
        pvTotalLabel.setAttribute('y', dataBoxY + 35);
        pvTotalLabel.setAttribute('font-family', 'Arial');
        pvTotalLabel.setAttribute('font-size', '9');
        pvTotalLabel.textContent = 'PV-Generator gesamt:';
        svg.appendChild(pvTotalLabel);

        const pvTotalValue = document.createElementNS(xmlns, 'text');
        pvTotalValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
        pvTotalValue.setAttribute('y', dataBoxY + 35);
        pvTotalValue.setAttribute('text-anchor', 'end');
        pvTotalValue.setAttribute('font-family', 'Arial');
        pvTotalValue.setAttribute('font-size', '9');
        pvTotalValue.setAttribute('font-weight', 'bold');
        pvTotalValue.textContent = `${(totalPvPower/1000).toFixed(2)} kWp`;
        svg.appendChild(pvTotalValue);

        // Wechselrichter gesamt
        const invTotalLabel = document.createElementNS(xmlns, 'text');
        invTotalLabel.setAttribute('x', dataBoxX + 10);
        invTotalLabel.setAttribute('y', dataBoxY + 50);
        invTotalLabel.setAttribute('font-family', 'Arial');
        invTotalLabel.setAttribute('font-size', '9');
        invTotalLabel.textContent = 'Wechselrichter gesamt:';
        svg.appendChild(invTotalLabel);

        const invTotalValue = document.createElementNS(xmlns, 'text');
        invTotalValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
        invTotalValue.setAttribute('y', dataBoxY + 50);
        invTotalValue.setAttribute('text-anchor', 'end');
        invTotalValue.setAttribute('font-family', 'Arial');
        invTotalValue.setAttribute('font-size', '9');
        invTotalValue.setAttribute('font-weight', 'bold');
        invTotalValue.textContent = `${(totalInvPower/1000).toFixed(2)} kW`;
        svg.appendChild(invTotalValue);

        // Speicherkapazität (nur wenn Batterie vorhanden)
        if (state.battery) {
          const batCapLabel = document.createElementNS(xmlns, 'text');
          batCapLabel.setAttribute('x', dataBoxX + 10);
          batCapLabel.setAttribute('y', dataBoxY + 65);
          batCapLabel.setAttribute('font-family', 'Arial');
          batCapLabel.setAttribute('font-size', '9');
          batCapLabel.textContent = 'Speicherkapazität:';
          svg.appendChild(batCapLabel);

          const batCapValue = document.createElementNS(xmlns, 'text');
          batCapValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
          batCapValue.setAttribute('y', dataBoxY + 65);
          batCapValue.setAttribute('text-anchor', 'end');
          batCapValue.setAttribute('font-family', 'Arial');
          batCapValue.setAttribute('font-size', '9');
          batCapValue.setAttribute('font-weight', 'bold');
          batCapValue.textContent = `${state.battery.kwh} kWh`;
          svg.appendChild(batCapValue);

          // Max. Batterieleistung (nur wenn angegeben)
          if (state.battery.power_kw && state.battery.power_kw > 0) {
            const batPowerLabel = document.createElementNS(xmlns, 'text');
            batPowerLabel.setAttribute('x', dataBoxX + 10);
            batPowerLabel.setAttribute('y', dataBoxY + 80);
            batPowerLabel.setAttribute('font-family', 'Arial');
            batPowerLabel.setAttribute('font-size', '9');
            batPowerLabel.textContent = 'Max. Batterieleistung:';
            svg.appendChild(batPowerLabel);

            const batPowerValue = document.createElementNS(xmlns, 'text');
            batPowerValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
            batPowerValue.setAttribute('y', dataBoxY + 80);
            batPowerValue.setAttribute('text-anchor', 'end');
            batPowerValue.setAttribute('font-family', 'Arial');
            batPowerValue.setAttribute('font-size', '9');
            batPowerValue.setAttribute('font-weight', 'bold');
            batPowerValue.textContent = `${state.battery.power_kw.toFixed(1)} kW`;
            svg.appendChild(batPowerValue);
          }
        }

        // Leistungsverhältnis (falls beide Werte > 0)
        let nextY = dataBoxY + 65; // Startwert für die nächste Y-Position
        if (totalPvPower > 0 && totalInvPower > 0) {
          const ratioY = state.battery ? (state.battery.power_kw > 0 ? dataBoxY + 95 : dataBoxY + 80) : dataBoxY + 65;

          const ratioLabel = document.createElementNS(xmlns, 'text');
          ratioLabel.setAttribute('x', dataBoxX + 10);
          ratioLabel.setAttribute('y', ratioY);
          ratioLabel.setAttribute('font-family', 'Arial');
          ratioLabel.setAttribute('font-size', '9');
          ratioLabel.textContent = 'Überdimensionierung:';
          svg.appendChild(ratioLabel);

          const ratioValue = document.createElementNS(xmlns, 'text');
          ratioValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
          ratioValue.setAttribute('y', ratioY);
          ratioValue.setAttribute('text-anchor', 'end');
          ratioValue.setAttribute('font-family', 'Arial');
          ratioValue.setAttribute('font-size', '9');
          ratioValue.setAttribute('font-weight', 'bold');
          ratioValue.textContent = `${(totalPvPower/totalInvPower).toFixed(2)}`;
          svg.appendChild(ratioValue);

          nextY = ratioY + 15; // Nächste Position nach Überdimensionierung
        } else {
          nextY = state.battery ? (state.battery.power_kw > 0 ? dataBoxY + 95 : dataBoxY + 80) : dataBoxY + 65;
        }

        // Notstrom-Information
        const emergencyPowerStatus = state.inverters.some(inv => inv.emergencyPower);
        const emergencyLabel = document.createElementNS(xmlns, 'text');
        emergencyLabel.setAttribute('x', dataBoxX + 10);
        emergencyLabel.setAttribute('y', nextY);
        emergencyLabel.setAttribute('font-family', 'Arial');
        emergencyLabel.setAttribute('font-size', '9');
        emergencyLabel.textContent = 'Notstrom:';
        svg.appendChild(emergencyLabel);

        const emergencyValue = document.createElementNS(xmlns, 'text');
        emergencyValue.setAttribute('x', dataBoxX + dataBoxWidth - 10);
        emergencyValue.setAttribute('y', nextY);
        emergencyValue.setAttribute('text-anchor', 'end');
        emergencyValue.setAttribute('font-family', 'Arial');
        emergencyValue.setAttribute('font-size', '9');
        emergencyValue.setAttribute('font-weight', 'bold');
        emergencyValue.textContent = emergencyPowerStatus ? 'Ja' : 'Nein';
        svg.appendChild(emergencyValue);

        // Draw PV areas - vertically arranged on the left
        state.solarAreas.forEach((sa, index) => {
          const x = pvX;
          const y = startY + (index * verticalSpacing);
          const spdX = x + 60; // Position SPD to the right of PV module

          // PV symbol
          const pvGroup = document.createElementNS(xmlns, 'use');
          pvGroup.setAttribute('href', '#pv-module');
          pvGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#pv-module');
          pvGroup.setAttribute('transform', `translate(${x}, ${y})`);
          svg.appendChild(pvGroup);

          // PV label
          const pvLabel = document.createElementNS(xmlns, 'text');
          pvLabel.setAttribute('x', x);
          pvLabel.setAttribute('y', y - 30);
          pvLabel.setAttribute('text-anchor', 'middle');
          pvLabel.setAttribute('font-family', 'Arial');
          pvLabel.setAttribute('font-size', '10');
          pvLabel.setAttribute('font-weight', 'bold');
          pvLabel.textContent = `${sa.name}`;
          svg.appendChild(pvLabel);

          const pvPower = document.createElementNS(xmlns, 'text');
          pvPower.setAttribute('x', x);
          pvPower.setAttribute('y', y - 20);
          pvPower.setAttribute('text-anchor', 'middle');
          pvPower.setAttribute('font-family', 'Arial');
          pvPower.setAttribute('font-size', '8');
          pvPower.setAttribute('fill', '#222');
          pvPower.textContent = `${sa.modules} × ${state.moduleConfig.wattage}W = ${(sa.modules * state.moduleConfig.wattage / 1000).toFixed(2)} kWp`;
          svg.appendChild(pvPower);

          // Line from PV to SPD
          const pvToSpdLine = document.createElementNS(xmlns, 'line');
          pvToSpdLine.setAttribute('x1', x + 25); // Right edge of PV module
          pvToSpdLine.setAttribute('y1', y);
          pvToSpdLine.setAttribute('x2', spdX - 8); // Left edge of SPD
          pvToSpdLine.setAttribute('y2', y);
          pvToSpdLine.setAttribute('stroke', '#000');
          pvToSpdLine.setAttribute('stroke-width', '2');
          pvToSpdLine.setAttribute('stroke-dasharray', '5,5');
          svg.appendChild(pvToSpdLine);

          // Surge protector symbol using createSPD
          const spdGroup = window.createSPD('', {x: spdX - 6, y: y - 7 });
          svg.appendChild(spdGroup);

          // SPD label
          const spdLabel = document.createElementNS(xmlns, 'text');
          spdLabel.setAttribute('x', spdX);
          spdLabel.setAttribute('y', y - 15);
          spdLabel.setAttribute('text-anchor', 'middle');
          spdLabel.setAttribute('font-family', 'Arial');
          spdLabel.setAttribute('font-size', '9');
          spdLabel.setAttribute('fill', '#000');
          spdLabel.setAttribute('font-weight', 'bold');
          spdLabel.textContent = 'SPD';
          svg.appendChild(spdLabel);
        });

        // Draw inverters - positioned at the center of their assigned PV modules
        state.inverters.forEach((inv, index) => {
          const x = invX;

          // Calculate the center Y position of assigned PV modules
          let invY;
          if (inv.assignedSolarAreaIds.length > 0) {
            // Find indices of assigned PV modules
            const assignedIndices = inv.assignedSolarAreaIds.map(saId =>
              state.solarAreas.findIndex(sa => sa.id === saId)
            ).filter(idx => idx !== -1);

            if (assignedIndices.length > 0) {
              // Calculate center position
              const minIndex = Math.min(...assignedIndices);
              const maxIndex = Math.max(...assignedIndices);
              const centerIndex = (minIndex + maxIndex) / 2;
              invY = startY + (centerIndex * verticalSpacing);
            } else {
              // Fallback: use sequential positioning
              invY = startY + (index * verticalSpacing);
            }
          } else {
            // No assigned PV modules: use sequential positioning
            invY = startY + (index * verticalSpacing);
          }

          const invGroup = document.createElementNS(xmlns, 'use');
          invGroup.setAttribute('href', '#inverter');
          invGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#inverter');
          invGroup.setAttribute('transform', `translate(${x}, ${invY})`);
          svg.appendChild(invGroup);

          const invLabel = document.createElementNS(xmlns, 'text');
          invLabel.setAttribute('x', x);
          invLabel.setAttribute('y', invY - 40);
          invLabel.setAttribute('text-anchor', 'middle');
          invLabel.setAttribute('font-family', 'Arial');
          invLabel.setAttribute('font-size', '10');
          invLabel.setAttribute('font-weight', 'bold');
          invLabel.textContent = inv.name;
          svg.appendChild(invLabel);

          const invInfo = document.createElementNS(xmlns, 'text');
          invInfo.setAttribute('x', x - 30);
          invInfo.setAttribute('y', invY - 30);
          invInfo.setAttribute('text-anchor', 'start');
          invInfo.setAttribute('font-family', 'Arial');
          invInfo.setAttribute('font-size', '8');
          invInfo.setAttribute('fill', '#222');
          invInfo.textContent = `${(inv.ac_power_w / 1000).toFixed(1)} kW | ${inv.phases}`;
          svg.appendChild(invInfo);

          // Store inverter position for later use
          inv._layoutY = invY;
          inv._layoutX = x;

          // Draw connections from SPD to inverter
          inv.assignedSolarAreaIds.forEach(saId => {
            const saIndex = state.solarAreas.findIndex(sa => sa.id === saId);
            if (saIndex !== -1) {
              const saX = pvX;
              const saY = startY + (saIndex * verticalSpacing);
              const spdX = saX + 60; // SPD position

              // DC connection line (horizontal from SPD to inverter)
              const dcLine = document.createElementNS(xmlns, 'line');
              dcLine.setAttribute('x1', spdX + 8); // Right edge of SPD
              dcLine.setAttribute('y1', saY);
              dcLine.setAttribute('x2', x - 30); // Left edge of inverter
              dcLine.setAttribute('y2', invY);
              dcLine.setAttribute('stroke', '#000');
              dcLine.setAttribute('stroke-width', '2');
              dcLine.setAttribute('stroke-dasharray', '5,5');
              svg.appendChild(dcLine);
            }
          });

        });

        // Calculate dynamic positions based on number of inverters
        const busLineY = Math.max(startY + (state.inverters.length * verticalSpacing), startY + 120); // Position below all inverters
        const meterY = busLineY; // Meter at same height as bus line

        // Draw main AC bus line (Sammelschiene) to meter - parallel connection
        const busStartX = invX + 115; // Start even further to the right to accommodate moved LS
        const busEndX = meterX - 30;

        const mainBusLine = document.createElementNS(xmlns, 'line');
        mainBusLine.setAttribute('x1', busStartX);
        mainBusLine.setAttribute('y1', busLineY);
        mainBusLine.setAttribute('x2', busEndX);
        mainBusLine.setAttribute('y2', busLineY);
        mainBusLine.setAttribute('stroke', '#000');
        mainBusLine.setAttribute('stroke-width', '4');
        svg.appendChild(mainBusLine);

        // Connect each inverter to the bus line (parallel connection) with circuit breakers
        state.inverters.forEach((inv, index) => {
          const x = invX;
          const y = inv._layoutY; // Use the calculated center position
          const lsX = x + 90; // Position LS even further to the right for better spacing

          // Use configured values or calculate as fallback
          const nominalCurrent = inv.ls_amps || calculateNominalCurrent(inv.ac_power_w, inv.phases);
          const cableSize = inv.cable_size || calculateCableSizeFromLsCurrent(nominalCurrent);

          // Bei Notstrom-WR: AC-Ausgang nach unten verschieben für Platz oberhalb
          const acLineY = inv.emergencyPower ? y + 15 : y;

          // Line from inverter to circuit breaker
          const invToLsLine = document.createElementNS(xmlns, 'line');
          invToLsLine.setAttribute('x1', x + 30); // Right edge of inverter
          invToLsLine.setAttribute('y1', acLineY);
          invToLsLine.setAttribute('x2', lsX - 10); // Left edge of LS
          invToLsLine.setAttribute('y2', acLineY);
          invToLsLine.setAttribute('stroke', '#000');
          invToLsLine.setAttribute('stroke-width', '3');
          svg.appendChild(invToLsLine);          // Cable cross-section label (between inverter and LS)
          const cableLabel = document.createElementNS(xmlns, 'text');
          cableLabel.setAttribute('x', x + 60); // Adjusted position for new LS location
          cableLabel.setAttribute('y', acLineY - 8);
          cableLabel.setAttribute('text-anchor', 'middle');
          cableLabel.setAttribute('font-family', 'Arial');
          cableLabel.setAttribute('font-size', '8');
          cableLabel.setAttribute('fill', '#222');
          cableLabel.textContent = '' // `${cableSize}mm²`;
          svg.appendChild(cableLabel);

          // Circuit breaker symbol
          const lsGroup = document.createElementNS(xmlns, 'use');
          lsGroup.setAttribute('href', '#circuit-breaker');
          lsGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#circuit-breaker');
          lsGroup.setAttribute('transform', `translate(${lsX}, ${acLineY}) rotate(90)`);
          svg.appendChild(lsGroup);

          // LS label (text "LS")
          const lsLabel = document.createElementNS(xmlns, 'text');
          lsLabel.setAttribute('x', lsX);
          lsLabel.setAttribute('y', acLineY - 20);
          lsLabel.setAttribute('text-anchor', 'middle');
          lsLabel.setAttribute('font-family', 'Arial');
          lsLabel.setAttribute('font-size', '9');
          lsLabel.setAttribute('fill', '#000');
          lsLabel.setAttribute('font-weight', 'bold');
          lsLabel.textContent = 'LS';
          svg.appendChild(lsLabel);

          // Circuit breaker label (nominal current)
          const lsInfo = document.createElementNS(xmlns, 'text');
          lsInfo.setAttribute('x', lsX);
          lsInfo.setAttribute('y', acLineY - 12);
          lsInfo.setAttribute('text-anchor', 'middle');
          lsInfo.setAttribute('font-family', 'Arial');
          lsInfo.setAttribute('font-size', '8');
          lsInfo.setAttribute('fill', '#222');
          lsInfo.textContent = `${nominalCurrent}A`;
          svg.appendChild(lsInfo);

          // Line from circuit breaker to bus collector
          const lsToBusLine = document.createElementNS(xmlns, 'line');
          lsToBusLine.setAttribute('x1', lsX + 10); // Right edge of LS
          lsToBusLine.setAttribute('y1', acLineY);
          lsToBusLine.setAttribute('x2', busStartX); // Connect to bus line start
          lsToBusLine.setAttribute('y2', acLineY);
          lsToBusLine.setAttribute('stroke', '#000');
          lsToBusLine.setAttribute('stroke-width', '3');
          svg.appendChild(lsToBusLine);

          // Vertical line from horizontal line to bus
          const invToBusLineVertical = document.createElementNS(xmlns, 'line');
          invToBusLineVertical.setAttribute('x1', busStartX);
          invToBusLineVertical.setAttribute('y1', acLineY);
          invToBusLineVertical.setAttribute('x2', busStartX);
          invToBusLineVertical.setAttribute('y2', busLineY);
          invToBusLineVertical.setAttribute('stroke', '#000');
          invToBusLineVertical.setAttribute('stroke-width', '3');
          svg.appendChild(invToBusLineVertical);

          // Junction point on bus line
          const junctionPoint = document.createElementNS(xmlns, 'circle');
          junctionPoint.setAttribute('cx', busStartX);
          junctionPoint.setAttribute('cy', busLineY);
          junctionPoint.setAttribute('r', '3');
          junctionPoint.setAttribute('fill', '#000');
          svg.appendChild(junctionPoint);
        });

        // Connection from bus line to meter
        const busToMeterLine = document.createElementNS(xmlns, 'line');
        busToMeterLine.setAttribute('x1', busEndX);
        busToMeterLine.setAttribute('y1', busLineY);
        busToMeterLine.setAttribute('x2', meterX - 30);
        busToMeterLine.setAttribute('y2', meterY);
        busToMeterLine.setAttribute('stroke', '#000');
        busToMeterLine.setAttribute('stroke-width', '4');
        svg.appendChild(busToMeterLine);

        // Draw battery if exists - positioned above first PV module on the left
        if (state.battery) {
          // Battery connection to inverter
          if (state.battery.assignedInvId) {
            const assignedInverter = state.inverters.find(inv => inv.id === state.battery.assignedInvId);
            if (assignedInverter) {
              const assignedInvX = invX;
              const assignedInvY = assignedInverter._layoutY; // Use the calculated center position
              // Position battery above the first PV module on the left side
              const batX = pvX; // Same X position as PV modules
              const batY = startY - 80; // Above the first PV module

              const batGroup = document.createElementNS(xmlns, 'use');
              batGroup.setAttribute('href', '#battery');
              batGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#battery');
              batGroup.setAttribute('transform', `translate(${batX}, ${batY})`);
              svg.appendChild(batGroup);

              const batLabel = document.createElementNS(xmlns, 'text');
              batLabel.setAttribute('x', batX);
              batLabel.setAttribute('y', batY - 35);
              batLabel.setAttribute('text-anchor', 'middle');
              batLabel.setAttribute('font-family', 'Arial');
              batLabel.setAttribute('font-size', '10');
              batLabel.setAttribute('font-weight', 'bold');
              batLabel.textContent = state.battery.name;
              svg.appendChild(batLabel);

              const batInfo = document.createElementNS(xmlns, 'text');
              batInfo.setAttribute('x', batX);
              batInfo.setAttribute('y', batY - 25);
              batInfo.setAttribute('text-anchor', 'middle');
              batInfo.setAttribute('font-family', 'Arial');
              batInfo.setAttribute('font-size', '8');
              batInfo.setAttribute('fill', '#222');
              batInfo.textContent = `${state.battery.kwh} kWh | ${state.battery.power_kw ? state.battery.power_kw + ' kW DC' : ''}`;
              svg.appendChild(batInfo);

              // L-shaped connection from battery (top-left) to inverter
              // Horizontal line from battery to the right
              const batLineHorizontal = document.createElementNS(xmlns, 'line');
              batLineHorizontal.setAttribute('x1', batX + 15); // Right edge of battery
              batLineHorizontal.setAttribute('y1', batY);
              batLineHorizontal.setAttribute('x2', assignedInvX - 50); // Stop before inverter
              batLineHorizontal.setAttribute('y2', batY);
              batLineHorizontal.setAttribute('stroke', '#000');
              batLineHorizontal.setAttribute('stroke-width', '2');
              batLineHorizontal.setAttribute('stroke-dasharray', '5,5');
              svg.appendChild(batLineHorizontal);

              // Vertical line down to inverter level
              const batLineVertical = document.createElementNS(xmlns, 'line');
              batLineVertical.setAttribute('x1', assignedInvX - 50);
              batLineVertical.setAttribute('y1', batY);
              batLineVertical.setAttribute('x2', assignedInvX - 50);
              batLineVertical.setAttribute('y2', assignedInvY);
              batLineVertical.setAttribute('stroke', '#000');
              batLineVertical.setAttribute('stroke-width', '2');
              batLineVertical.setAttribute('stroke-dasharray', '5,5');
              svg.appendChild(batLineVertical);

              // Final horizontal line to inverter
              const batLineToInv = document.createElementNS(xmlns, 'line');
              batLineToInv.setAttribute('x1', assignedInvX - 50);
              batLineToInv.setAttribute('y1', assignedInvY);
              batLineToInv.setAttribute('x2', assignedInvX - 30); // Left edge of inverter
              batLineToInv.setAttribute('y2', assignedInvY);
              batLineToInv.setAttribute('stroke', '#000');
              batLineToInv.setAttribute('stroke-width', '2');
              batLineToInv.setAttribute('stroke-dasharray', '5,5');
              svg.appendChild(batLineToInv);

              // Junction points
              const batJunction1 = document.createElementNS(xmlns, 'circle');
              batJunction1.setAttribute('cx', assignedInvX - 50);
              batJunction1.setAttribute('cy', batY);
              batJunction1.setAttribute('r', '2');
              batJunction1.setAttribute('fill', '#000');
              svg.appendChild(batJunction1);

              const batJunction2 = document.createElementNS(xmlns, 'circle');
              batJunction2.setAttribute('cx', assignedInvX - 50);
              batJunction2.setAttribute('cy', assignedInvY);
              batJunction2.setAttribute('r', '2');
              batJunction2.setAttribute('fill', '#000');
              svg.appendChild(batJunction2);
            }
          }
        }

        // Draw meter
        const meterGroup = document.createElementNS(xmlns, 'use');
        meterGroup.setAttribute('href', '#meter');
        meterGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#meter');
        meterGroup.setAttribute('transform', `translate(${meterX}, ${meterY})`);
        svg.appendChild(meterGroup);

        const meterLabel = document.createElementNS(xmlns, 'text');
        meterLabel.setAttribute('x', meterX);
        meterLabel.setAttribute('y', meterY - 40);
        meterLabel.setAttribute('text-anchor', 'middle');
        meterLabel.setAttribute('font-family', 'Arial');
        meterLabel.setAttribute('font-size', '10');
        meterLabel.setAttribute('font-weight', 'bold');
        meterLabel.textContent = 'Zweirichtungszähler';
        svg.appendChild(meterLabel);        // Check if any inverter has emergency power
        const hasEmergencyPower = state.inverters.some(inv => inv.emergencyPower);

        if (hasEmergencyPower) {
          // Notstrom-Layout: Haus rechts vom Umschalter
          const emergencyInv = state.inverters.find(inv => inv.emergencyPower);

          // Bei mehr als 3 Solarflächen: Umschalter und Haus oberhalb der busLineY positionieren
          const hasManySolarAreas = emergencyInv.assignedSolarAreaIds.length > 3;
          let switchX, switchY, houseX, houseY;
          if (hasManySolarAreas) {
            // Position oberhalb der busLineY mit mehr Abstand
            switchX = emergencyInv._layoutX + 160;
            switchY = busLineY - 80; // Weit oberhalb der busLineY
            houseX = switchX + 80;
            houseY = switchY - 10;
          } else {
            // Normale Position bei <= 3 Solarflächen
            switchX = emergencyInv._layoutX + 160;
            switchY = emergencyInv._layoutY - 15; // Auf Höhe der Notstrom-Leitung
            houseX = switchX + 80;
            houseY = switchY - 10;
          }

          // 1|0|2 Umschalter Symbol
          const switchRect = document.createElementNS(xmlns, 'rect');
          switchRect.setAttribute('x', switchX - 25);
          switchRect.setAttribute('y', switchY - 15);
          switchRect.setAttribute('width', '50');
          switchRect.setAttribute('height', '30');
          switchRect.setAttribute('fill', 'none');
          switchRect.setAttribute('stroke', '#000');
          switchRect.setAttribute('stroke-width', '2');
          svg.appendChild(switchRect);

          // Umschalter-Beschriftung
          const switchLabel = document.createElementNS(xmlns, 'text');
          switchLabel.setAttribute('x', switchX);
          switchLabel.setAttribute('y', switchY + 2);
          switchLabel.setAttribute('text-anchor', 'middle');
          switchLabel.setAttribute('font-family', 'Arial');
          switchLabel.setAttribute('font-size', '12');
          switchLabel.setAttribute('font-weight', 'bold');
          switchLabel.textContent = '1|0|2';
          svg.appendChild(switchLabel);

          // Umschalter Info
          const switchInfo = document.createElementNS(xmlns, 'text');
          switchInfo.setAttribute('x', switchX);
          switchInfo.setAttribute('y', switchY - 30);
          switchInfo.setAttribute('text-anchor', 'middle');
          switchInfo.setAttribute('font-family', 'Arial');
          switchInfo.setAttribute('font-size', '10');
          switchInfo.setAttribute('font-weight', 'bold');
          switchInfo.setAttribute('fill', '#000');
          switchInfo.textContent = 'Lastumschalter';
          svg.appendChild(switchInfo);

          // Umschalter details
          const switchDetail = document.createElementNS(xmlns, 'text');
          switchDetail.setAttribute('x', switchX);
          switchDetail.setAttribute('y', switchY - 20);
          switchDetail.setAttribute('text-anchor', 'middle');
          switchDetail.setAttribute('font-family', 'Arial');
          switchDetail.setAttribute('font-size', '8');
          switchDetail.setAttribute('fill', '#222');
          switchDetail.textContent = '4polig, 63A';
          svg.appendChild(switchDetail);

          // Anschlüsse am Umschalter
          // Position 1 (links): Wechselrichter - immer links mittig, egal wie viele Solarflächen
          const switch1Circle = document.createElementNS(xmlns, 'circle');
          switch1Circle.setAttribute('cx', switchX - 25);
          switch1Circle.setAttribute('cy', switchY);
          switch1Circle.setAttribute('r', '2');
          switch1Circle.setAttribute('fill', '#000');
          svg.appendChild(switch1Circle);

          // Position 2 (unten): Netz
          const switch2Circle = document.createElementNS(xmlns, 'circle');
          switch2Circle.setAttribute('cx', switchX);
          switch2Circle.setAttribute('cy', switchY + 15);
          switch2Circle.setAttribute('r', '2');
          switch2Circle.setAttribute('fill', '#000');
          svg.appendChild(switch2Circle);

          // Ausgang (rechts): Haus
          const switchOutCircle = document.createElementNS(xmlns, 'circle');
          switchOutCircle.setAttribute('cx', switchX + 25);
          switchOutCircle.setAttribute('cy', switchY);
          switchOutCircle.setAttribute('r', '2');
          switchOutCircle.setAttribute('fill', '#000');
          svg.appendChild(switchOutCircle);

          let emergencyY;
          // Notstrom-Leitung vom Wechselrichter zum Umschalter (Position 1 - links)
          if (hasManySolarAreas) {
            // Bei mehr als 3 Solarflächen: Einfache L-Route - nach oben, dann nach rechts
            emergencyY = emergencyInv._layoutY - 15; // Startpunkt oberhalb der normalen AC-Leitung
            const routeOverY = busLineY - 100; // Höhe für die Route über busLineY

            // 1. Horizontale Linie am Wechselrichter Ausgang
            const emergencyLineStart = document.createElementNS(xmlns, 'line');
            emergencyLineStart.setAttribute('x1', emergencyInv._layoutX + 30);
            emergencyLineStart.setAttribute('y1', emergencyY);
            emergencyLineStart.setAttribute('x2', emergencyInv._layoutX + 80);
            emergencyLineStart.setAttribute('y2', emergencyY);
            emergencyLineStart.setAttribute('stroke', '#ff0000');
            emergencyLineStart.setAttribute('stroke-width', '3');
            emergencyLineStart.setAttribute('stroke-dasharray', '10,5');
            svg.appendChild(emergencyLineStart);

            // 2. Vertikale Linie nach oben über busLineY
            const emergencyLine1 = document.createElementNS(xmlns, 'line');
            emergencyLine1.setAttribute('x1', emergencyInv._layoutX + 80);
            emergencyLine1.setAttribute('y1', emergencyY);
            emergencyLine1.setAttribute('x2', emergencyInv._layoutX + 80);
            emergencyLine1.setAttribute('y2', switchY);
            emergencyLine1.setAttribute('stroke', '#ff0000');
            emergencyLine1.setAttribute('stroke-width', '3');
            emergencyLine1.setAttribute('stroke-dasharray', '10,5');
            svg.appendChild(emergencyLine1);

            // 3. Horizontale Linie nach rechts zum Umschalter
            const emergencyLine2 = document.createElementNS(xmlns, 'line');
            emergencyLine2.setAttribute('x1', emergencyInv._layoutX + 80);
            emergencyLine2.setAttribute('y1', switchY);
            emergencyLine2.setAttribute('x2', switchX - 25);
            emergencyLine2.setAttribute('y2', switchY);
            emergencyLine2.setAttribute('stroke', '#ff0000');
            emergencyLine2.setAttribute('stroke-width', '3');
            emergencyLine2.setAttribute('stroke-dasharray', '10,5');
            svg.appendChild(emergencyLine2);

            // Junction points für bessere Sichtbarkeit
            const junction1 = document.createElementNS(xmlns, 'circle');
            junction1.setAttribute('cx', emergencyInv._layoutX + 80);
            junction1.setAttribute('cy', switchY);
            junction1.setAttribute('r', '2');
            junction1.setAttribute('fill', '#ff0000');
            svg.appendChild(junction1);

            const junction2 = document.createElementNS(xmlns, 'circle');
            junction2.setAttribute('cx', switchX - 25);
            junction2.setAttribute('cy', switchY);
            junction2.setAttribute('r', '2');
            junction2.setAttribute('fill', '#ff0000');
            svg.appendChild(junction2);
          } else {
            // Normale direkte Route bei <= 3 Solarflächen
            emergencyY = emergencyInv._layoutY - 15; // Oberhalb der normalen AC-Leitung

            const emergencyLine1 = document.createElementNS(xmlns, 'line');
            emergencyLine1.setAttribute('x1', emergencyInv._layoutX + 30);
            emergencyLine1.setAttribute('y1', emergencyY);
            emergencyLine1.setAttribute('x2', switchX - 25);
            emergencyLine1.setAttribute('y2', emergencyY);
            emergencyLine1.setAttribute('stroke', '#ff0000');
            emergencyLine1.setAttribute('stroke-width', '3');
            emergencyLine1.setAttribute('stroke-dasharray', '10,5');
            svg.appendChild(emergencyLine1);

            const emergencyLine2 = document.createElementNS(xmlns, 'line');
            emergencyLine2.setAttribute('x1', switchX - 25);
            emergencyLine2.setAttribute('y1', emergencyY);
            emergencyLine2.setAttribute('x2', switchX - 25);
            emergencyLine2.setAttribute('y2', switchY);
            emergencyLine2.setAttribute('stroke', '#ff0000');
            emergencyLine2.setAttribute('stroke-width', '3');
            emergencyLine2.setAttribute('stroke-dasharray', '10,5');
            svg.appendChild(emergencyLine2);
          }

          // Netz-Leitung vom Meter zum Umschalter (Position 2 - unten)
          const meterToSwitchLine1 = document.createElementNS(xmlns, 'line');
          meterToSwitchLine1.setAttribute('x1', meterX - 30);
          meterToSwitchLine1.setAttribute('y1', meterY);
          meterToSwitchLine1.setAttribute('x2', switchX);
          meterToSwitchLine1.setAttribute('y2', meterY);
          meterToSwitchLine1.setAttribute('stroke', '#000');
          meterToSwitchLine1.setAttribute('stroke-width', '3');
          svg.appendChild(meterToSwitchLine1);

          const meterToSwitchLine2 = document.createElementNS(xmlns, 'line');
          meterToSwitchLine2.setAttribute('x1', switchX);
          meterToSwitchLine2.setAttribute('y1', meterY);
          meterToSwitchLine2.setAttribute('x2', switchX);
          meterToSwitchLine2.setAttribute('y2', switchY + 15);
          meterToSwitchLine2.setAttribute('stroke', '#000');
          meterToSwitchLine2.setAttribute('stroke-width', '3');
          svg.appendChild(meterToSwitchLine2);

          // Leitung vom Umschalter zum Haus (rechts)
          const switchToHouseLine = document.createElementNS(xmlns, 'line');
          switchToHouseLine.setAttribute('x1', switchX + 25);
          switchToHouseLine.setAttribute('y1', switchY);
          switchToHouseLine.setAttribute('x2', houseX - 20);
          switchToHouseLine.setAttribute('y2', houseY + 10);
          switchToHouseLine.setAttribute('stroke', '#000');
          switchToHouseLine.setAttribute('stroke-width', '3');
          svg.appendChild(switchToHouseLine);

          // Haus-Symbol (rechts vom Umschalter)
          const loadRect = document.createElementNS(xmlns, 'rect');
          loadRect.setAttribute('x', houseX - 20);
          loadRect.setAttribute('y', houseY);
          loadRect.setAttribute('width', '40');
          loadRect.setAttribute('height', '20');
          loadRect.setAttribute('fill', 'none');
          loadRect.setAttribute('stroke', '#000');
          loadRect.setAttribute('stroke-width', '2');
          svg.appendChild(loadRect);

          // Haus-Label
          const loadLabel = document.createElementNS(xmlns, 'text');
          loadLabel.setAttribute('x', houseX + 25);
          loadLabel.setAttribute('y', houseY + 15);
          loadLabel.setAttribute('text-anchor', 'start');
          loadLabel.setAttribute('font-family', 'Arial');
          loadLabel.setAttribute('font-size', '10');
          loadLabel.setAttribute('font-weight', 'bold');
          loadLabel.textContent = 'Haus';
          svg.appendChild(loadLabel);

          // Notstrom-Label
          const emergencyLabel = document.createElementNS(xmlns, 'text');
          if (hasManySolarAreas) {
            // Bei mehr als 3 Solarflächen: Label oberhalb der ersten horizontalen Linie
            emergencyLabel.setAttribute('x', emergencyInv._layoutX + 85);
            emergencyLabel.setAttribute('y', switchY - 10); // Weiter oberhalb
          } else {
            // Bei <= 3 Solarflächen: Label oberhalb der horizontalen Linie
            emergencyLabel.setAttribute('x', emergencyInv._layoutX + 85);
            emergencyLabel.setAttribute('y', emergencyInv._layoutY - 25); // Weiter oberhalb
          }
          emergencyLabel.setAttribute('text-anchor', 'start');
          emergencyLabel.setAttribute('font-family', 'Arial');
          emergencyLabel.setAttribute('font-size', '9');
          emergencyLabel.setAttribute('fill', '#ff0000');
          emergencyLabel.setAttribute('font-weight', 'bold');
          emergencyLabel.textContent = 'Notstrom';
          svg.appendChild(emergencyLabel);

        } else {
          // Normales Layout: Haus unten
          const loadBranchX = busEndX - 160; // Position on the bus line

          // Junction point on bus line for load
          const loadJunctionPoint = document.createElementNS(xmlns, 'circle');
          loadJunctionPoint.setAttribute('cx', loadBranchX);
          loadJunctionPoint.setAttribute('cy', busLineY);
          loadJunctionPoint.setAttribute('r', '3');
          loadJunctionPoint.setAttribute('fill', '#000');
          svg.appendChild(loadJunctionPoint);

          // Line down from bus line to load
          const loadToBusLine = document.createElementNS(xmlns, 'line');
          loadToBusLine.setAttribute('x1', loadBranchX);
          loadToBusLine.setAttribute('y1', busLineY);
          loadToBusLine.setAttribute('x2', loadBranchX);
          loadToBusLine.setAttribute('y2', busLineY + 80);
          loadToBusLine.setAttribute('stroke', '#000');
          loadToBusLine.setAttribute('stroke-width', '3');
          svg.appendChild(loadToBusLine);

          // Draw load symbol (Messkonzept-Style with arrows)
          const loadRect = document.createElementNS(xmlns, 'rect');
          loadRect.setAttribute('x', loadBranchX - 20);
          loadRect.setAttribute('y', busLineY + 80);
          loadRect.setAttribute('width', '40');
          loadRect.setAttribute('height', '20');
          loadRect.setAttribute('fill', 'none');
          loadRect.setAttribute('stroke', '#000');
          loadRect.setAttribute('stroke-width', '2');
          svg.appendChild(loadRect);

          // Load label
          const loadLabel = document.createElementNS(xmlns, 'text');
          loadLabel.setAttribute('x', loadBranchX + 25);
          loadLabel.setAttribute('y', busLineY + 95);
          loadLabel.setAttribute('text-anchor', 'start');
          loadLabel.setAttribute('font-family', 'Arial');
          loadLabel.setAttribute('font-size', '10');
          loadLabel.setAttribute('font-weight', 'bold');
          loadLabel.textContent = 'Haus';
          svg.appendChild(loadLabel);
        }

        // Draw SPD Typ 2 - position depends on emergency power
        if (hasEmergencyPower) {
          // Position SPD Typ 2 above the house
          const emergencyInv = state.inverters.find(inv => inv.emergencyPower);
          const hasManySolarAreas = emergencyInv.assignedSolarAreaIds.length > 3;
          let switchX, switchY, houseX, houseY;

          if (hasManySolarAreas) {
            switchX = emergencyInv._layoutX + 160;
            switchY = busLineY - 80;
            houseX = switchX + 80;
            houseY = switchY - 10;
          } else {
            switchX = emergencyInv._layoutX + 160;
            switchY = emergencyInv._layoutY - 15;
            houseX = switchX + 80;
            houseY = switchY - 10;
          }

          const spdType2X = houseX;
          const spdType2Y = houseY - 50;
          const spdType2Box = createSPD('SPD Type 2', { x: spdType2X - 5, y: spdType2Y });
          svg.appendChild(spdType2Box);

          // Verbindungslinie vom SPD: nach oben, dann links, dann runter auf die Leitung zwischen Lastumschalter und Haus
          const spdTopY = spdType2Y ; // Oben am SPD (SPD hat etwa 14px Höhe nach oben)
          const connectionHighY = spdTopY - 20; // Noch etwas höher gehen
          const switchToHouseLineX = switchX + 52; // Mittig auf der Leitung zwischen Umschalter und Haus

          // 1. Vertikale Linie von oben am SPD nach oben
          const spdTopLine = document.createElementNS(xmlns, 'line');
          spdTopLine.setAttribute('x1', spdType2X);
          spdTopLine.setAttribute('y1', spdTopY);
          spdTopLine.setAttribute('x2', spdType2X);
          spdTopLine.setAttribute('y2', connectionHighY);
          spdTopLine.setAttribute('stroke', '#000');
          spdTopLine.setAttribute('stroke-width', '2');
          svg.appendChild(spdTopLine);

          // 2. Horizontale Linie nach links
          const spdToSwitchHorizontal = document.createElementNS(xmlns, 'line');
          spdToSwitchHorizontal.setAttribute('x1', spdType2X);
          spdToSwitchHorizontal.setAttribute('y1', connectionHighY);
          spdToSwitchHorizontal.setAttribute('x2', switchToHouseLineX);
          spdToSwitchHorizontal.setAttribute('y2', connectionHighY);
          spdToSwitchHorizontal.setAttribute('stroke', '#000');
          spdToSwitchHorizontal.setAttribute('stroke-width', '2');
          svg.appendChild(spdToSwitchHorizontal);

          // 3. Vertikale Linie nach unten zur Leitung zwischen Umschalter und Haus
          const spdDownLine = document.createElementNS(xmlns, 'line');
          spdDownLine.setAttribute('x1', switchToHouseLineX);
          spdDownLine.setAttribute('y1', connectionHighY);
          spdDownLine.setAttribute('x2', switchToHouseLineX);
          spdDownLine.setAttribute('y2', switchY);
          spdDownLine.setAttribute('stroke', '#000');
          spdDownLine.setAttribute('stroke-width', '2');
          svg.appendChild(spdDownLine);

          // Junction point auf der Leitung zwischen Umschalter und Haus
          const spdJunction = document.createElementNS(xmlns, 'circle');
          spdJunction.setAttribute('cx', switchToHouseLineX);
          spdJunction.setAttribute('cy', switchY);
          spdJunction.setAttribute('r', '2');
          spdJunction.setAttribute('fill', '#000');
          svg.appendChild(spdJunction);

        } else {
          // Draw SPD Typ 2 on AC busbar (behind load and meters) - original position
          const spdType2X = busEndX - 70; // Position on the bus line (right of load)

          // SPD Typ 2 junction point on busbar
          const spdType2JunctionPoint = document.createElementNS(xmlns, 'circle');
          spdType2JunctionPoint.setAttribute('cx', spdType2X);
          spdType2JunctionPoint.setAttribute('cy', busLineY);
          spdType2JunctionPoint.setAttribute('r', '3');
          spdType2JunctionPoint.setAttribute('fill', '#000');
          svg.appendChild(spdType2JunctionPoint);

          // SPD Typ 2 vertical line from busbar
          const spdType2ToBusLine = document.createElementNS(xmlns, 'line');
          spdType2ToBusLine.setAttribute('x1', spdType2X);
          spdType2ToBusLine.setAttribute('y1', busLineY);
          spdType2ToBusLine.setAttribute('x2', spdType2X);
          spdType2ToBusLine.setAttribute('y2', busLineY + 40);
          spdType2ToBusLine.setAttribute('stroke', '#000');
          spdType2ToBusLine.setAttribute('stroke-width', '2');
          svg.appendChild(spdType2ToBusLine);

          const spdType2Box = createSPD('SPD Type 2', { x: spdType2X - 5, y: busLineY + 40 });
          svg.appendChild(spdType2Box);
        }

        // Connection from SPD Kombi to SLS
        const spdKombiToSlsLine = document.createElementNS(xmlns, 'line');
        spdKombiToSlsLine.setAttribute('x1', spdKombiX - 12);
        spdKombiToSlsLine.setAttribute('y1', meterY);
        spdKombiToSlsLine.setAttribute('x2', slsX - 12);
        spdKombiToSlsLine.setAttribute('y2', meterY);
        spdKombiToSlsLine.setAttribute('stroke', '#000');
        spdKombiToSlsLine.setAttribute('stroke-width', '3');
        svg.appendChild(spdKombiToSlsLine);

        // Add SLS 35A symbol
        const slsGroup = document.createElementNS(xmlns, 'use');
        slsGroup.setAttribute('href', '#selective-circuit-breaker');
        slsGroup.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#selective-circuit-breaker');
        slsGroup.setAttribute('transform', `translate(${slsX}, ${meterY}) rotate(90)`);
        svg.appendChild(slsGroup);

        const slsLabel = document.createElementNS(xmlns, 'text');
        slsLabel.setAttribute('x', slsX);
        slsLabel.setAttribute('y', meterY - 26);
        slsLabel.setAttribute('text-anchor', 'middle');
        slsLabel.setAttribute('font-family', 'Arial');
        slsLabel.setAttribute('font-size', '9');
        slsLabel.setAttribute('font-weight', 'bold');
        slsLabel.textContent = 'SLS';
        svg.appendChild(slsLabel);

        const slsInfo = document.createElementNS(xmlns, 'text');
        slsInfo.setAttribute('x', slsX);
        slsInfo.setAttribute('y', meterY - 16);
        slsInfo.setAttribute('text-anchor', 'middle');
        slsInfo.setAttribute('font-family', 'Arial');
        slsInfo.setAttribute('font-size', '8');
        slsInfo.setAttribute('fill', '#222');
        slsInfo.textContent = '35A';
        svg.appendChild(slsInfo);

        // Connection from SLS to HAK
        const slsToHakLine = document.createElementNS(xmlns, 'line');
        slsToHakLine.setAttribute('x1', slsX + 12);
        slsToHakLine.setAttribute('y1', meterY);
        slsToHakLine.setAttribute('x2', hakX - 15);
        slsToHakLine.setAttribute('y2', meterY);
        slsToHakLine.setAttribute('stroke', '#000');
        slsToHakLine.setAttribute('stroke-width', '3');
        svg.appendChild(slsToHakLine);



        // Connection from meter to SPD Kombi
        const meterToSpdKombiLine = document.createElementNS(xmlns, 'line');
        meterToSpdKombiLine.setAttribute('x1', meterX + 25);
        meterToSpdKombiLine.setAttribute('y1', meterY);
        meterToSpdKombiLine.setAttribute('x2', spdKombiX - 12);
        meterToSpdKombiLine.setAttribute('y2', meterY);
        meterToSpdKombiLine.setAttribute('stroke', '#000');
        meterToSpdKombiLine.setAttribute('stroke-width', '3');
        svg.appendChild(meterToSpdKombiLine);

        // Add HAK (Hauptanschlusskasten) symbol at new position
        const hakSymbol = document.createElementNS(xmlns, 'rect');
        hakSymbol.setAttribute('x', hakX - 15);
        hakSymbol.setAttribute('y', meterY - 15);
        hakSymbol.setAttribute('width', '30');
        hakSymbol.setAttribute('height', '30');
        hakSymbol.setAttribute('fill', 'none');
        hakSymbol.setAttribute('stroke', '#000');
        hakSymbol.setAttribute('stroke-width', '2');
        svg.appendChild(hakSymbol);

        // HAK internal structure (simplified)
        const hakLine1 = document.createElementNS(xmlns, 'line');
        hakLine1.setAttribute('x1', hakX - 10);
        hakLine1.setAttribute('y1', meterY - 10);
        hakLine1.setAttribute('x2', hakX + 10);
        hakLine1.setAttribute('y2', meterY - 10);
        hakLine1.setAttribute('stroke', '#000');
        hakLine1.setAttribute('stroke-width', '1');
        svg.appendChild(hakLine1);

        const hakLine2 = document.createElementNS(xmlns, 'line');
        hakLine2.setAttribute('x1', hakX - 10);
        hakLine2.setAttribute('y1', meterY);
        hakLine2.setAttribute('x2', hakX + 10);
        hakLine2.setAttribute('y2', meterY);
        hakLine2.setAttribute('stroke', '#000');
        hakLine2.setAttribute('stroke-width', '1');
        svg.appendChild(hakLine2);

        const hakLine3 = document.createElementNS(xmlns, 'line');
        hakLine3.setAttribute('x1', hakX - 10);
        hakLine3.setAttribute('y1', meterY + 10);
        hakLine3.setAttribute('x2', hakX + 10);
        hakLine3.setAttribute('y2', meterY + 10);
        hakLine3.setAttribute('stroke', '#000');
        hakLine3.setAttribute('stroke-width', '1');
        svg.appendChild(hakLine3);

        const hakLabel = document.createElementNS(xmlns, 'text');
        hakLabel.setAttribute('x', hakX);
        hakLabel.setAttribute('y', meterY - 20);
        hakLabel.setAttribute('text-anchor', 'middle');
        hakLabel.setAttribute('font-family', 'Arial');
        hakLabel.setAttribute('font-size', '9');
        hakLabel.setAttribute('font-weight', 'bold');
        hakLabel.textContent = 'HAK';
        svg.appendChild(hakLabel);

        // SPD Kombi - draw inline like SPD Type 2
        // Vertical line from busbar down
        const spdKombiToBusLine = document.createElementNS(xmlns, 'line');
        spdKombiToBusLine.setAttribute('x1', spdKombiX);
        spdKombiToBusLine.setAttribute('y1', meterY);
        spdKombiToBusLine.setAttribute('x2', spdKombiX);
        spdKombiToBusLine.setAttribute('y2', meterY + 40);
        spdKombiToBusLine.setAttribute('stroke', '#000');
        spdKombiToBusLine.setAttribute('stroke-width', '2');
        svg.appendChild(spdKombiToBusLine);

        // SPD Kombi rectangle box
        const spdKombiBox = createSPD('SPD Kombi', { x: spdKombiX - 5, y: meterY + 40 });
        svg.appendChild(spdKombiBox);


        notes = [
          'Alle PV-Strings lassen sich an den Wechselrichteren abschalten (DC-Trennvorrichtung)',
          'Der Akkuspeicher und der Wechselrichter haben eine DC-Trennvorrichtung',
          'NA-Schutz nach VDE-AR-N 4105 integriert in Wechselrichtern',
          'Alle metallischen PV-Komponenten und SPDs sind mit dem Hauptpotentialausgleich verbunden'
        ]
        notes.unshift(`Modulbezeichnung: ${state.moduleConfig.info}`);
        let yNotes = height - ((notes.length + 1) * 15);
        // Fußnote für Hinweise
        const footnoteTitle = document.createElementNS(xmlns, 'text');
        footnoteTitle.setAttribute('x', '600');
        footnoteTitle.setAttribute('y', yNotes);
        footnoteTitle.setAttribute('font-family', 'Arial');
        footnoteTitle.setAttribute('font-size', '10');
        footnoteTitle.setAttribute('font-weight', 'bold');
        footnoteTitle.textContent = 'Hinweise:';
        svg.appendChild(footnoteTitle);

        for (let i = 0; i < notes.length; i++) {
          const noteText = document.createElementNS(xmlns, 'text');
          noteText.setAttribute('x', '600');
          noteText.setAttribute('y', yNotes + 15 * (i + 1));
          noteText.setAttribute('font-family', 'Arial');
          noteText.setAttribute('font-size', '9');
          noteText.textContent = `• ${notes[i]}`;
          svg.appendChild(noteText);
        }

        legend = [
          'HAK: Hauptanschlusskasten',
          'LS: Leitungsschutzschalter',
          'SPD: Überspannungsschutzgerät',
          'SLS: Selektiver Leitungsschutzschalter'
        ]
        let yLegend = 510;
        let xLegend = 820;
        // Fußnote für Legende
        const legendTitle = document.createElementNS(xmlns, 'text');
        legendTitle.setAttribute('x', xLegend);
        legendTitle.setAttribute('y', yLegend);
        legendTitle.setAttribute('font-family', 'Arial');
        legendTitle.setAttribute('font-size', '10');
        legendTitle.setAttribute('font-weight', 'bold');
        legendTitle.textContent = 'Legende:';
        svg.appendChild(legendTitle);

        for (let i = 0; i < legend.length; i++) {
          const legendText = document.createElementNS(xmlns, 'text');
          legendText.setAttribute('x', xLegend);
          legendText.setAttribute('y', yLegend + 15 * (i + 1));
          legendText.setAttribute('font-family', 'Arial');
          legendText.setAttribute('font-size', '9');
          legendText.textContent = `• ${legend[i]}`;
          svg.appendChild(legendText);
        }
        return svg;
      }

      async function renderPreview(){
        if(state.solarAreas.length===0 && state.inverters.length===0){ alert('Füge mindestens eine Solarfläche oder einen Wechselrichter hinzu.'); return; }

        try{
          // Generate professional electrical schematic
          const svg = buildProfessionalSVG();

          // put svg into preview
          const wrap = $('svgWrap');
          wrap.innerHTML = '';
          wrap.appendChild(svg);
        }catch(err){
          alert('Fehler bei Schaltplan-Generierung: '+err.message);
          console.error(err);
        }
      }



      $('gen').addEventListener('click', ()=>{ renderPreview(); });

      // Professional PDF export (A4 landscape) with enhanced layout
      $('exportPdf').addEventListener('click', async ()=>{
        const svgEl = $('svgWrap').querySelector('svg');
        if(!svgEl) return alert('SVG nicht gefunden');

        try{
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

          // A4 landscape dimensions in mm
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Nur SVG: seitenfüllend (fit-to-page, keine Ränder)
          const svgClone = svgEl.cloneNode(true);
          svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

          // 1) <use>-Elemente inline expandieren, damit nichts abgeschnitten wird
          (function inlineUse(root){
            const uses = Array.from(root.querySelectorAll('use'));
            uses.forEach(use => {
              const href = use.getAttribute('href') || use.getAttributeNS('http://www.w3.org/1999/xlink','href');
              if(!href || !href.startsWith('#')) return;
              const id = href.slice(1);
              const def = svgClone.querySelector(`#${CSS.escape(id)}`);
              if(!def) return;
              const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
              // Transform übernehmen
              const tf = use.getAttribute('transform');
              if(tf) g.setAttribute('transform', tf);
              // Inhalt klonen
              const cloned = def.cloneNode(true);
              // id entfernen, um Duplikate zu vermeiden
              cloned.removeAttribute('id');
              g.appendChild(cloned);
              // use ersetzen
              use.replaceWith(g);
            });
          })(svgClone);

          // 2) BBox korrekt ermitteln: temporär in DOM einfügen, viewBox setzen
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'fixed';
          tempContainer.style.left = '-10000px';
          tempContainer.style.top = '-10000px';
          document.body.appendChild(tempContainer);
          tempContainer.appendChild(svgClone);
          try {
            const bbox = svgClone.getBBox();
            if(bbox && isFinite(bbox.x) && isFinite(bbox.y) && isFinite(bbox.width) && isFinite(bbox.height) && bbox.width>0 && bbox.height>0){
              const pad = 2;
              const vbX = bbox.x - pad;
              const vbY = bbox.y - pad;
              const vbW = bbox.width + 2*pad;
              const vbH = bbox.height + 2*pad;
              svgClone.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`);
              svgClone.removeAttribute('width');
              svgClone.removeAttribute('height');
            }
          } finally {
            // im DOM belassen, bis svg2pdf gerendert hat (damit Styles/BBox stabil bleiben)
          }
          // SVG-Logikgröße bestimmen
          let vb = svgClone.viewBox && svgClone.viewBox.baseVal;
          let svgW = (vb && vb.width) ? vb.width : parseFloat(svgClone.getAttribute('width')) || 1000;
          let svgH = (vb && vb.height) ? vb.height : parseFloat(svgClone.getAttribute('height')) || 700;

          // Fit-to-page Skalierung (Seite komplett ausnutzen, Seitenverhältnis beibehalten)
          const scale = Math.min(pageWidth / svgW, pageHeight / svgH);
          const drawW = svgW * scale;
          const drawH = svgH * scale;
          const xOffset = (pageWidth - drawW) / 2;
          const yOffset = (pageHeight - drawH) / 2;

          // Nur SVG in PDF rendern
          await window.svg2pdf.svg2pdf(svgClone, pdf, {
            xOffset,
            yOffset,
            scale
          });
          // temporären Knoten entfernen
          if(tempContainer && tempContainer.parentNode){
            tempContainer.parentNode.removeChild(tempContainer);
          }

          pdf.save((state.projectName || 'Stromlaufplan') + '.pdf');
        }catch(err){
          alert('PDF Export fehlgeschlagen: '+err.message);
          console.error(err);
        }
      });

      // initial render
      $('moduleInfo').value = state.moduleConfig.info;
      $('moduleWattage').value = state.moduleConfig.wattage;
      renderLists();

      // Set initial LS and cable suggestions
      updateLsSuggestion();

    })();

  </script>
</body>
</html>
